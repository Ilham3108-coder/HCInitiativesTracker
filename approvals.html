<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approval Dashboard - HC Initiatives Tracker</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <!-- Particle Grid Background -->
    <div class="particle-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="layout-dashboard"></i>
            <span>HC Initiatives Tracker</span>
        </div>

        <a href="dashboard.html" class="nav-item">
            <i data-lucide="layout-dashboard"></i> <span class="menu-text">Dashboard Overview</span>
        </a>
        <a href="projects.html" class="nav-item">
            <i data-lucide="folder-kanban"></i> <span class="menu-text">Initiatives</span>
        </a>
        <a href="owners.html" class="nav-item">
            <i data-lucide="users"></i> <span class="menu-text">Owners</span>
        </a>
        <a href="analytics.html" class="nav-item">
            <i data-lucide="bar-chart-2"></i> <span class="menu-text">Analytic</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <i data-lucide="bell"></i> <span class="menu-text">Notifications</span>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="timeline.html" class="nav-item">
            <i data-lucide="calendar"></i> <span class="menu-text">Timeline</span>
        </a>
        <a href="approvals.html" class="nav-item active" id="approvalsLink">
            <i data-lucide="check-circle"></i> <span class="menu-text">Approvals</span>
            <span id="approvalBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="user-management.html" class="nav-item">
            <i data-lucide="user-cog"></i> <span class="menu-text">User Management</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i data-lucide="settings"></i> <span class="menu-text">Setting</span>
        </a>

        <!-- Logout Button at Bottom -->
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="#" onclick="confirmLogout(event)" class="nav-item" style="color: #ff0055;">
                <i data-lucide="log-out"></i> <span class="menu-text">Logout</span>
            </a>
        </div>
    </nav>

    <!-- Logout Modal -->
    <div id="logoutModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 20px 60px rgba(255, 0, 85, 0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">Confirm Logout</h3>
            <p style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">Are you sure you want to
                logout?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="proceedLogout()"
                    style="padding: 12px; background: linear-gradient(135deg, #ff0055, #ff8800); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                    Logout</button>
                <button onclick="closeLogoutModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content fade-in-up" style="position: relative; z-index: 10;">
        <header style="margin-bottom: 30px;">
            <h1 class="gradient-text" style="font-size: 28px; margin-bottom: 5px;">Approval Dashboard</h1>
            <p style="color: var(--text-muted); font-size: 14px;">Review and approve pending initiatives</p>
        </header>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card"
                style="background: linear-gradient(135deg, rgba(255, 191, 0, 0.1), rgba(255, 153, 0, 0.05)); border-left: 3px solid #ffbf00;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Pending Approval</div>
                <div style="font-size: 32px; font-weight: 700; color: #ffbf00;" id="pendingCount">0</div>
            </div>
            <div class="stat-card"
                style="background: linear-gradient(135deg, rgba(0, 255, 157, 0.1), rgba(0, 238, 187, 0.05)); border-left: 3px solid #00ff9d;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Approved Today</div>
                <div style="font-size: 32px; font-weight: 700; color: #00ff9d;" id="approvedTodayCount">0</div>
            </div>
            <div class="stat-card"
                style="background: linear-gradient(135deg, rgba(255, 0, 85, 0.1), rgba(255, 0, 85, 0.05)); border-left: 3px solid #ff0055;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Rejected Today</div>
                <div style="font-size: 32px; font-weight: 700; color: #ff0055;" id="rejectedTodayCount">0</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="stat-card" style="padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="filterStatus" onchange="filterApprovals()"
                    style="padding: 8px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 13px;">
                    <option value="pending">Pending</option>
                    <option value="pending_update">Pending Update</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="all">All</option>
                </select>
                <select id="filterEntity" onchange="filterApprovals()"
                    style="padding: 8px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 13px;">
                    <option value="all">All Entities</option>
                    <!-- Populated by JS -->
                </select>
                <button onclick="refreshApprovals()"
                    style="padding: 8px 16px; background: rgba(0, 136, 255, 0.2); color: #0088ff; border: 1px solid #0088ff; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="refresh-cw" style="width: 14px; margin-right: 6px;"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Approvals List -->
        <div id="approvalsList" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Populated by JS -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
            <i data-lucide="inbox"
                style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 20px;"></i>
            <h3 style="color: white; margin-bottom: 10px;">No Pending Approvals</h3>
            <p style="color: var(--text-muted);">All initiatives have been reviewed</p>
        </div>
        <!-- Generic Confirmation Modal -->
        <div id="confirmationModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10050; align-items: center; justify-content: center;">
            <div
                style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(0, 136, 255, 0.3); box-shadow: 0 20px 60px rgba(0, 136, 255, 0.4);">
                <h3 id="confirmationTitle"
                    style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">
                    Confirm Action</h3>
                <p id="confirmationMessage" style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">
                    Are
                    you sure?</p>
                <div id="modalBtnContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button id="confirmBtn" onclick="confirmAction()"
                        style="padding: 12px; background: linear-gradient(135deg, #0088ff, #00f2ea); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                        Confirm</button>
                    <button id="cancelBtn" onclick="closeConfirmationModal()"
                        style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Rejection Modal -->
    <div id="rejectionModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 500px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3);">
            <h3 style="margin: 0 0 20px 0; font-size: 20px; color: white;">Reject Initiative</h3>
            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Rejection
                Reason</label>
            <textarea id="rejectionReason" placeholder="Enter reason for rejection..."
                style="width: 100%; min-height: 100px; padding: 10px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button onclick="confirmReject()"
                    style="padding: 12px; background: linear-gradient(135deg, #ff0055, #ff8800); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Reject</button>
                <button onclick="closeRejectionModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Initiative Detail Modal -->
    <div id="initiativeDetailModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid rgba(0, 136, 255, 0.3); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 30px 30px 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 20px; color: white;">Initiative Details</h3>
                <button onclick="closeInitiativeDetail()"
                    style="background: none; border: none; color: white; cursor: pointer; padding: 5px;">
                    <i data-lucide="x" style="width: 24px;"></i>
                </button>
            </div>
            <div id="initiativeDetailContent" style="color: white; overflow-y: auto; padding: 0 30px 30px 30px;">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Success Checklist Modal -->
    <div id="successChecklistModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 11000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.98), rgba(26, 31, 46, 0.98)); border-radius: 20px; width: 400px; padding: 30px; border: 1px solid rgba(0, 255, 157, 0.3); box-shadow: 0 0 50px rgba(0, 255, 157, 0.2); text-align: center;">

            <div
                style="background: rgba(0, 255, 157, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto;">
                <i data-lucide="check" style="width: 40px; height: 40px; color: #00ff9d;"></i>
            </div>

            <h3 style="margin: 0 0 10px 0; font-size: 24px; color: white;">Approval Confirmed</h3>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 25px;">The initiative has been
                successfully processed.</p>

            <div
                style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; text-align: left; margin-bottom: 10px;">
                <div class="checklist-item"
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; opacity: 0; animation: fadeInItem 0.4s forwards 0.1s;">
                    <div
                        style="background: #00ff9d; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="check" style="width: 12px; height: 12px; color: black; stroke-width: 3;"></i>
                    </div>
                    <span style="color: white; font-size: 14px;">Status set to <strong>'Approved'</strong></span>
                </div>
                <div class="checklist-item"
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; opacity: 0; animation: fadeInItem 0.4s forwards 0.3s;">
                    <div
                        style="background: #00ff9d; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="bell" style="width: 12px; height: 12px; color: black; stroke-width: 3;"></i>
                    </div>
                    <span style="color: white; font-size: 14px;">Notification sent to Owner</span>
                </div>
                <div class="checklist-item"
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; opacity: 0; animation: fadeInItem 0.4s forwards 0.5s;">
                    <div
                        style="background: #00ff9d; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="bar-chart-2"
                            style="width: 12px; height: 12px; color: black; stroke-width: 3;"></i>
                    </div>
                    <span style="color: white; font-size: 14px;">Dashboard Stats Updated</span>
                </div>
                <div class="checklist-item"
                    style="display: flex; align-items: center; gap: 12px; opacity: 0; animation: fadeInItem 0.4s forwards 0.7s;">
                    <div
                        style="background: #00ff9d; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="activity" style="width: 12px; height: 12px; color: black; stroke-width: 3;"></i>
                    </div>
                    <span style="color: white; font-size: 14px;">Initiative Active in Tracker</span>
                </div>
            </div>

            <button onclick="closeSuccessChecklist()"
                style="width: 100%; padding: 14px; background: #00ff9d; color: black; border: none; border-radius: 8px; font-weight: 700; font-size: 15px; cursor: pointer; transition: transform 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                Continue
            </button>
        </div>
    </div>

    <style>
        @keyframes fadeInItem {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Scripts -->
    <script src="js/data.js"></script>
    <script src="js/rbac.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/menu-names.js"></script>
    <script src="js/logout.js"></script>
    <script>
        // Confirmation Modal Logic
        let pendingAction = null;

        function showConfirmation(title, message, action) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const btnContainer = document.getElementById('modalBtnContainer');

            // Reset to Confirmation Mode
            confirmBtn.textContent = 'Yes, Confirm';
            confirmBtn.onclick = confirmAction;
            confirmBtn.style.background = 'linear-gradient(135deg, #0088ff, #00f2ea)';
            cancelBtn.style.display = 'block';
            btnContainer.style.gridTemplateColumns = '1fr 1fr';

            pendingAction = action;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function showAlert(title, message, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const btnContainer = document.getElementById('modalBtnContainer');

            // Set to Alert Mode
            confirmBtn.textContent = 'OK';
            confirmBtn.onclick = function () {
                closeConfirmationModal();
                if (callback) callback();
            };
            confirmBtn.style.background = 'linear-gradient(135deg, #00ff9d, #00f2ea)'; // Greenish for Success/Info
            cancelBtn.style.display = 'none';
            btnContainer.style.gridTemplateColumns = '1fr'; // Full width

            pendingAction = null;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeConfirmationModal();
        }

        let currentRejectId = null;

        // Check if user is admin
        if (!rbac.isAdmin()) {
            showAlert('Access Denied', 'Only administrators can access this page.', function () {
                window.location.href = 'dashboard.html';
            });
        }

        // Load approvals
        function loadApprovals() {
            const initiatives = JSON.parse(localStorage.getItem('initiatives') || '[]');
            const filterStatus = document.getElementById('filterStatus').value;
            const filterEntity = document.getElementById('filterEntity').value;

            let filtered = initiatives;

            // Filter by status
            if (filterStatus !== 'all') {
                if (filterStatus === 'pending') {
                    // Show BOTH pending creation and pending updates
                    filtered = filtered.filter(i => i.approvalStatus === 'pending' || i.approvalStatus === 'pending_update');
                } else {
                    filtered = filtered.filter(i => i.approvalStatus === filterStatus);
                }
            }

            // Filter by entity
            if (filterEntity !== 'all') {
                filtered = filtered.filter(i => i.entity === filterEntity);
            }

            // Update stats
            updateStats(initiatives);

            // Display approvals
            displayApprovals(filtered);
        }

        // Update stats
        function updateStats(initiatives) {
            const pending = initiatives.filter(i => i.approvalStatus === 'pending' || i.approvalStatus === 'pending_update').length;
            const today = new Date().toDateString();
            const approvedToday = initiatives.filter(i =>
                i.approvalStatus === 'approved' &&
                i.approvedAt &&
                new Date(i.approvedAt).toDateString() === today
            ).length;
            const rejectedToday = initiatives.filter(i =>
                i.approvalStatus === 'rejected' &&
                i.rejectedAt &&
                new Date(i.rejectedAt).toDateString() === today
            ).length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedTodayCount').textContent = approvedToday;
            document.getElementById('rejectedTodayCount').textContent = rejectedToday;

            // Update badge
            const badge = document.getElementById('approvalBadge');
            if (badge) {
                if (pending > 0) {
                    badge.textContent = pending;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Display approvals
        function displayApprovals(approvals) {
            const container = document.getElementById('approvalsList');
            const emptyState = document.getElementById('emptyState');

            if (approvals.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            let html = '';
            approvals.forEach(init => {
                const statusColor = {
                    'pending': '#ffbf00',
                    'pending_update': '#00d9ff',
                    'approved': '#00ff9d',
                    'rejected': '#ff0055'
                }[init.approvalStatus] || '#888';

                const statusLabel = {
                    'pending': 'Pending',
                    'pending_update': 'Pending Update',
                    'approved': 'Approved',
                    'rejected': 'Rejected'
                }[init.approvalStatus] || 'Unknown';

                html += `
                    <div class="stat-card" style="padding: 20px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0; font-size: 18px; color: white; cursor: pointer; text-decoration: underline;" onclick="showInitiativeDetail('${init.id}')">${init.name}</h3>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted);">
                                    <span><i data-lucide="user" style="width: 12px; display: inline; margin-right: 4px;"></i>${init.createdBy || init.owner}</span>
                                    <span><i data-lucide="building" style="width: 12px; display: inline; margin-right: 4px;"></i>${init.entity}</span>
                                    <span><i data-lucide="calendar" style="width: 12px; display: inline; margin-right: 4px;"></i>${new Date(init.dueDate || Date.now()).toLocaleDateString('id-ID')}</span>
                                </div>
                            </div>
                            <div style="padding: 4px 12px; background: rgba(${statusColor === '#ffbf00' ? '255,191,0' : statusColor === '#00ff9d' ? '0,255,157' : '255,0,85'},0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: ${statusColor};">
                                ${statusLabel}
                            </div>
                        </div>
                        
                        ${init.output ? `<p style="margin: 0 0 15px 0; color: var(--text-muted); font-size: 14px;"><strong>Output:</strong> ${init.output}</p>` : ''}
                        
                        ${(init.approvalStatus === 'pending' || init.approvalStatus === 'pending_update') ? `
                            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
                                <button onclick="approveInitiative('${init.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #00ff9d, #00eebb); color: black; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; min-width: 100px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="check" style="width: 14px; margin-right: 6px;"></i>
                                    Approve
                                </button>
                                <button onclick="showRejectModal('${init.id}')" style="padding: 8px 16px; background: rgba(255, 0, 85, 0.2); color: #ff0055; border: 1px solid #ff0055; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; min-width: 100px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="x" style="width: 14px; margin-right: 6px;"></i>
                                    Reject
                                </button>
                            </div>
                        ` : ''}
                        
                        ${init.approvalStatus === 'rejected' && init.rejectionReason ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 0, 85, 0.1); border-left: 2px solid #ff0055; border-radius: 4px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Rejection Reason:</div>
                                <div style="font-size: 13px; color: #ff0055;">${init.rejectionReason}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons();
        }

        // Approve initiative
        function approveInitiative(id) {
            console.log('âœ… Approving initiative:', id);

            showConfirmation('Approve Initiative', 'Are you sure you want to approve this initiative?', function () {
                // Convert ID to number if it's a string
                const initiativeId = typeof id === 'string' ? parseInt(id) : id;

                if (rbac.approveInitiative(initiativeId)) {
                    // Replaced Generic Alert with Checklist Modal
                    // showAlert('Success', 'âœ… Initiative approved successfully!');
                    showSuccessChecklist();
                } else {
                    showAlert('Error', 'Error: Failed to approve initiative');
                    console.error('Approve failed for ID:', initiativeId);
                }
            });
        }

        function showSuccessChecklist() {
            const modal = document.getElementById('successChecklistModal');
            modal.style.display = 'flex';
            lucide.createIcons();

            // Re-trigger animations by reflowing? 
            // The css animation runs on display:flex. 
            // If we want to restart it every time:
            const items = modal.querySelectorAll('.checklist-item');
            items.forEach(item => {
                item.style.animation = 'none';
                item.offsetHeight; /* trigger reflow */
                item.style.animation = null;
            });
        }

        function closeSuccessChecklist() {
            document.getElementById('successChecklistModal').style.display = 'none';
            loadApprovals();
        }

        // Show reject modal
        function showRejectModal(id) {
            currentRejectId = id;
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionModal').style.display = 'flex';
        }

        // Close reject modal
        function closeRejectionModal() {
            currentRejectId = null;
            document.getElementById('rejectionModal').style.display = 'none';
        }

        // Confirm reject
        function confirmReject() {
            const reason = document.getElementById('rejectionReason').value.trim();

            console.log('ðŸ”´ Rejecting initiative:', currentRejectId, 'Reason:', reason);

            if (!reason) {
                showAlert('Validation Error', 'Please enter a rejection reason');
                return;
            }

            if (!currentRejectId) {
                showAlert('Error', 'Error: No initiative selected');
                return;
            }

            // Convert ID to number if it's a string
            const initiativeId = typeof currentRejectId === 'string' ? parseInt(currentRejectId) : currentRejectId;

            if (rbac.rejectInitiative(initiativeId, reason)) {
                showAlert('Success', 'âŒ Initiative rejected', function () {
                    closeRejectionModal();
                    loadApprovals();
                });
            } else {
                showAlert('Error', 'Error: Failed to reject initiative');
                console.error('Reject failed for ID:', initiativeId);
            }
        }

        // Filter approvals
        function filterApprovals() {
            loadApprovals();
        }

        // Refresh approvals
        function refreshApprovals() {
            loadApprovals();
        }

        // Populate entity filter
        function populateEntityFilter() {
            const initiatives = JSON.parse(localStorage.getItem('initiatives') || '[]');
            const entities = [...new Set(initiatives.map(i => i.entity))].filter(e => e);
            const select = document.getElementById('filterEntity');

            // Entity Name Mapping
            const entityNames = {
                'ptpn1': 'PT Perkebunan Nusantara I',
                'ptpn3': 'PT Perkebunan Nusantara III (Persero)',
                'ptpn4': 'PT Perkebunan Nusantara IV',
                'sgn': 'PT Sinergi Gula Nusantara',
                'lpp': 'PT LPP Agro Nusantara',
                'medika': 'PT Sri Pamela Medika Nusantara',
                'rpn': 'PT Riset Perkebunan Nusantara',
                'kpbn': 'PT Kharisma Pemasaran Bersama Nusantara',
                'bio': 'PT Bio Industri Nusantara',
                'kin': 'PT Kawasan Industri Nusantara',
                'ikn': 'PT Industri Karet Nusantara'
            };

            entities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity;
                // Use mapped name if available, otherwise fallback to entity code
                option.textContent = entityNames[entity] || entity;
                // Apply dark theme styling
                option.style.background = '#1a1a2e';
                option.style.color = 'white';
                select.appendChild(option);
            });
        }

        // Show initiative detail
        function showInitiativeDetail(id) {
            const initiatives = JSON.parse(localStorage.getItem('initiatives') || '[]');
            const init = initiatives.find(i => i.id == id);

            if (!init) {
                showAlert('Error', 'Initiative not found');
                return;
            }

            const pending = (init.approvalStatus === 'pending_update' && init.pendingUpdate) ? init.pendingUpdate : null;

            const content = document.getElementById('initiativeDetailContent');
            const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

            let html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Basic Information</h4>
                    ${renderDiffFields(init, pending)}
                </div>

                ${(init.output || (pending && pending.output)) ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Output</h4>
                    ${renderDiffValue('Output', init.output, pending ? pending.output : init.output, true)}
                </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Financial</h4>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 14px;">
                        ${renderFinancialDiff('Budget', init.budget, pending ? pending.budget : init.budget)}
                        ${renderFinancialDiff('Cost', init.cost, pending ? pending.cost : init.cost)}
                    </div>
                </div>

                ${renderKeyActivitiesDiff(init, pending)}

                ${renderIndicatorsDiff(init, pending)}

                ${renderEvidenceDiff(init, pending)}

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 12px; color: var(--text-muted);">
                        <div>Created By:</div>
                        <div>${init.createdBy || init.owner}</div>
                        <div>Approval Status:</div>
                        <div style="color: ${init.approvalStatus === 'approved' ? '#00ff9d' : init.approvalStatus === 'pending' ? '#ffbf00' : '#ff0055'};">
                            ${init.approvalStatus || 'approved'}
                        </div>
                        ${pending ? `
                        <div>Update Requested By:</div>
                        <div style="color: white;">${pending.updatedBy || 'Unknown User'}</div>
                        <div>Update Requested At:</div>
                        <div>${pending.updatedAt ? new Date(pending.updatedAt).toLocaleString('id-ID') : '-'}</div>
                        ` : ''}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 30px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                    ${(init.approvalStatus === 'pending' || init.approvalStatus === 'pending_update') ? `
                    <button onclick="closeInitiativeDetail(); approveInitiative('${init.id}')" 
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, #00ff9d, #00eebb); color: black; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        <i data-lucide="check" style="width: 16px; display: inline; vertical-align: middle; margin-right: 5px;"></i> Approve
                    </button>
                    <button onclick="closeInitiativeDetail(); showRejectModal('${init.id}')" 
                        style="flex: 1; padding: 12px; background: rgba(255, 0, 85, 0.1); color: #ff0055; border: 1px solid #ff0055; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        <i data-lucide="x" style="width: 16px; display: inline; vertical-align: middle; margin-right: 5px;"></i> Reject
                    </button>
                    ` : ''}
                    <button onclick="closeInitiativeDetail()" 
                        style="padding: 12px 20px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Close
                    </button>
                </div>
            `;

            content.innerHTML = html;
            document.getElementById('initiativeDetailModal').style.display = 'flex';
            lucide.createIcons();
        }

        // --- DIFF HELPERS ---
        function renderDiffFields(current, pending) {
            const fields = [
                { label: 'Name', key: 'name' },
                { label: 'Owner', key: 'owner' },
                { label: 'Entity', key: 'entity' },
                { label: 'Due Date', key: 'dueDate', type: 'date' },
                { label: 'Status', key: 'status' },
                { label: 'Progress', key: 'progress', suffix: '%' }
            ];

            // If no pending, just render normal
            if (!pending) {
                return `
                <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 14px;">
                    ${fields.map(f => `
                        <div style="color: var(--text-muted);">${f.label}:</div>
                        <div>${formatValue(current[f.key], f.type) || '-'}${f.suffix || ''}</div>
                    `).join('')}
                </div>`;
            }

            // With Pending, render Diff Rows
            return `
            <div style="display: flex; flex-direction: column; gap: 10px;">
                 <div style="display: grid; grid-template-columns: 150px 1fr 1fr; gap: 10px; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px;">
                    <div></div>
                    <div style="color: var(--text-muted); font-weight: bold;">Current</div>
                    <div style="color: #00eebb; font-weight: bold;">Proposed Update</div>
                </div>
                ${fields.map(f => {
                const currVal = current[f.key];
                const propVal = pending[f.key];
                const isChanged = currVal != propVal; // loose equality for string/number match

                const displayCurr = (formatValue(currVal, f.type) || '-') + (f.suffix || '');
                const displayProp = (formatValue(propVal, f.type) || '-') + (f.suffix || '');

                if (!isChanged) {
                    return `
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 14px; opacity: 0.7;">
                            <div style="color: var(--text-muted);">${f.label}:</div>
                            <div>${displayCurr}</div>
                        </div>`;
                }

                return `
                    <div style="display: grid; grid-template-columns: 150px 1fr 1fr; gap: 10px; font-size: 14px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px;">
                        <div style="color: white; font-weight: 500;">${f.label}:</div>
                        <div style="color: var(--text-muted); text-decoration: line-through;">${displayCurr}</div>
                        <div style="color: #00eebb; font-weight: bold;">${displayProp}</div>
                    </div>`;
            }).join('')}
            </div>`;
        }

        function renderFinancialDiff(label, current, proposed) {
            const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);

            if (current == proposed) {
                return `
                    <div style="color: var(--text-muted);">${label}:</div>
                    <div>${formatRupiah(current)}</div>`;
            }

            return `
                <div style="color: var(--text-muted); grid-column: 1 / -1; margin-top: 5px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr 1fr; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px;">
                        <div>${label}:</div>
                         <div style="color: var(--text-muted); text-decoration: line-through;">${formatRupiah(current)}</div>
                         <div style="color: #00eebb; font-weight: bold;">${formatRupiah(proposed)}</div>
                    </div>
                </div>`;
        }

        function renderDiffValue(label, current, proposed, isFullWidth = false) {
            if (current == proposed) {
                return `<p style="margin: 0; color: var(--text-muted);">${current}</p>`;
            }
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Current</div>
                        <div style="color: var(--text-muted); text-decoration: line-through;">${current || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #00eebb; margin-bottom: 4px;">Proposed</div>
                        <div style="color: #00eebb;">${proposed || '-'}</div>
                    </div>
                </div>`;
        }

        function renderKeyActivitiesDiff(init, pending) {
            const currActs = init.subInitiatives || [];
            const propActs = pending ? (pending.subInitiatives || []) : currActs;

            if (!pending) {
                if (currActs.length === 0) return '';
                return `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Key Activities (${currActs.length})</h4>
                    ${currActs.map((sub, idx) => renderActivityCard(sub, idx)).join('')}
                </div>`;
            }

            // Compare Key Activities
            const content = propActs.map((prop, idx) => {
                const curr = currActs[idx];
                // Check if changed
                let isChanged = false;
                if (!curr) isChanged = true; // New activity
                else if (curr.name !== prop.name || curr.weight != prop.weight || curr.progress != prop.progress || curr.dueDate !== prop.dueDate) {
                    isChanged = true;
                }

                if (!isChanged) {
                    return renderActivityCard(prop, idx, false); // No Highlight
                }

                // Render Diff Card
                return `
                <div style="padding: 10px; background: rgba(0, 238, 187, 0.1); border: 1px solid rgba(0, 238, 187, 0.3); border-radius: 6px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                         <div style="font-weight: 600; color: #00eebb;">${idx + 1}. ${prop.name} (Updated)</div>
                         <div style="font-size: 10px; background: #00eebb; color: black; padding: 2px 6px; border-radius: 4px;">MODIFIED</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; margin-top: 5px;">
                        <!-- Comparison -->
                        ${curr ? `
                        <div style="opacity: 0.6;">
                            <div style="font-size: 10px; text-transform: uppercase;">Previous</div>
                            <div>Name: ${curr.name}</div>
                            <div>Weight: ${curr.weight}% | Prog: ${curr.progress}%</div>
                            <div>Due: ${formatDate(curr.dueDate)}</div>
                        </div>` : '<div>New Item</div>'}

                        <div style="color: #00eebb; font-weight: bold;">
                             <div style="font-size: 10px; text-transform: uppercase;">Proposed</div>
                             <div>Name: ${prop.name}</div>
                             <div>Weight: ${prop.weight}% | Prog: ${prop.progress}%</div>
                             <div>Due: ${formatDate(prop.dueDate)}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            return `
             <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #0088ff;">Key Activities (Proposed Logic)</h4>
                ${content}
            </div>`;
        }

        function renderIndicatorsDiff(init, pending) {
            const currInds = init.indicators || [];
            const propInds = pending ? (pending.indicators || []) : currInds;

            if (!pending) {
                if (currInds.length === 0) return '';
                return `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Leading & Lagging Indicators (${currInds.length})</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; color: var(--text-muted);">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                    <th style="padding: 8px;">Type</th>
                                    <th style="padding: 8px;">Metric</th>
                                    <th style="padding: 8px;">UoM</th>
                                    <th style="padding: 8px;">Target</th>
                                    <th style="padding: 8px;">Realization</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currInds.map(ind => `
                                <tr>
                                    <td style="padding: 8px;">${ind.type}</td>
                                    <td style="padding: 8px;">${ind.metric}</td>
                                    <td style="padding: 8px;">${ind.uom}</td>
                                    <td style="padding: 8px;">${ind.target}</td>
                                    <td style="padding: 8px;">${ind.realization || '-'}</td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            // Compare Indicators
            // Simple comparison based on index or content? 
            // Since there's no ID for indicators, we'll try to map by index if lengths are same, 
            // or just show two lists if lengths differ significantly or just list Proposed with diff highlighting if possible.
            // A safer approach for this context (no unique IDs) is to list Proposed, and maybe highlight if it looks new/changed.
            // Or better: Show side-by-side if counts match, otherwise just show Proposed list marked as "Modified List".

            const content = propInds.map((prop, idx) => {
                const curr = currInds[idx];
                let isChanged = false;

                if (!curr) isChanged = true; // New
                else if (curr.type !== prop.type || curr.metric !== prop.metric || curr.uom !== prop.uom || curr.target !== prop.target || curr.realization !== prop.realization) {
                    isChanged = true;
                }

                if (!isChanged) {
                    return `
                    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px;">
                         <div style="font-weight: 600; font-size: 13px; margin-bottom: 5px; color: white;">${prop.metric}</div>
                         <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px; color: var(--text-muted);">
                            <div>${prop.type}</div>
                            <div>${prop.uom}</div>
                            <div>T: ${prop.target}</div>
                            <div>R: ${prop.realization || '-'}</div>
                         </div>
                    </div>`;
                }

                // Render Diff Card
                return `
                <div style="padding: 10px; background: rgba(0, 238, 187, 0.1); border: 1px solid rgba(0, 238, 187, 0.3); border-radius: 6px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                         <div style="font-weight: 600; color: #00eebb; font-size: 13px;">${prop.metric}</div>
                         <div style="font-size: 10px; background: #00eebb; color: black; padding: 2px 6px; border-radius: 4px;">UPDATED</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; margin-top: 5px;">
                        ${curr ? `
                        <div style="opacity: 0.6;">
                            <div style="font-size: 10px; text-transform: uppercase;">Previous</div>
                            <div>${curr.type} | ${curr.uom}</div>
                            <div>Target: ${curr.target}</div>
                            <div>Realization: ${curr.realization || '-'}</div>
                        </div>` : '<div>New Indicator</div>'}

                        <div style="color: #00eebb; font-weight: bold;">
                             <div style="font-size: 10px; text-transform: uppercase;">Proposed</div>
                             <div>${prop.type} | ${prop.uom}</div>
                             <div>Target: ${prop.target}</div>
                             <div>Realization: ${prop.realization || '-'}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            return `
             <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #0088ff;">Leading & Lagging Indicators (Proposed)</h4>
                ${content}
            </div>`;


        }

        function renderActivityCard(sub, idx, highlight = false) {
            return `
                <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${idx + 1}. ${sub.name}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px; color: var(--text-muted);">
                        <div>Weight: ${sub.weight}%</div>
                        <div>Progress: ${sub.progress}%</div>
                        <div>Due: ${formatDate(sub.dueDate)}</div>
                    </div>
                </div>`;
        }

        function formatValue(val, type) {
            if (type === 'date') return formatDate(val);
            return val;
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString('id-ID') : 'N/A';
        }




        function renderEvidenceDiff(init, pending) {
            // Only visible to Admins
            if (!rbac.isAdmin()) return '';

            const currEv = init.evidence;
            const propEv = pending ? pending.evidence : null;

            if (!currEv && !propEv) return '';

            const renderEvidenceItem = (ev) => {
                if (!ev) return '<span style="color: var(--text-muted);">-</span>';
                if (ev.type === 'file') {
                    return `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="file-text" style="width: 14px; color: #00ff9d;"></i>
                            <span style="color: white;">${ev.name}</span>
                            <a href="${ev.content}" download="${ev.name}" 
                               style="padding: 2px 8px; background: rgba(0, 255, 157, 0.1); border: 1px solid #00ff9d; border-radius: 4px; color: #00ff9d; font-size: 10px; text-decoration: none;">
                               Download
                            </a>
                        </div>
                    `;
                } else {
                    // Default to Link
                    return `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="link" style="width: 14px; color: #0088ff;"></i>
                            <a href="${ev.url}" target="_blank" style="color: #0088ff; text-decoration: underline; word-break: break-all;">${ev.url}</a>
                        </div>
                    `;
                }
            };

            if (!pending) {
                return `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Evidence (Admin Only)</h4>
                    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        ${renderEvidenceItem(currEv)}
                    </div>
                </div>`;
            }

            const isChanged = JSON.stringify(currEv) !== JSON.stringify(propEv);

            if (!isChanged) {
                return `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0088ff;">Evidence (Admin Only)</h4>
                    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        ${renderEvidenceItem(currEv)}
                    </div>
                </div>`;
            }

            return `
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #0088ff;">Evidence (Proposed Change)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase;">Current</div>
                        ${renderEvidenceItem(currEv)}
                    </div>
                    <div style="padding: 10px; background: rgba(0, 238, 187, 0.1); border: 1px solid rgba(0, 238, 187, 0.3); border-radius: 6px;">
                        <div style="font-size: 11px; color: #00eebb; margin-bottom: 5px; text-transform: uppercase;">Proposed</div>
                        ${renderEvidenceItem(propEv)}
                    </div>
                </div>
            </div>`;
        }

        // Close initiative detail
        function closeInitiativeDetail() {
            document.getElementById('initiativeDetailModal').style.display = 'none';
        }

        // Initialize
        populateEntityFilter();
        loadApprovals();
        lucide.createIcons();
    </script>
</body>

</html>