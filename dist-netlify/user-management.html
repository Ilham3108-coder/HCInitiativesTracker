<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - HC Initiatives Tracker</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <!-- Particle Grid Background -->
    <div class="particle-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="layout-dashboard"></i>
            <span>HC Initiatives Tracker</span>
        </div>

        <a href="dashboard.html" class="nav-item">
            <i data-lucide="layout-dashboard"></i> <span class="menu-text">Dashboard Overview</span>
        </a>
        <a href="projects.html" class="nav-item">
            <i data-lucide="folder-kanban"></i> <span class="menu-text">Initiatives</span>
        </a>
        <a href="owners.html" class="nav-item">
            <i data-lucide="users"></i> <span class="menu-text">Owners</span>
        </a>
        <a href="analytics.html" class="nav-item">
            <i data-lucide="bar-chart-2"></i> <span class="menu-text">Analytic</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <i data-lucide="bell"></i> <span class="menu-text">Notifications</span>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="timeline.html" class="nav-item">
            <i data-lucide="calendar"></i> <span class="menu-text">Timeline</span>
        </a>
        <a href="approvals.html" class="nav-item" id="approvalsLink">
            <i data-lucide="check-circle"></i> <span class="menu-text">Approvals</span>
            <span id="approvalsBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="user-management.html" class="nav-item active">
            <i data-lucide="user-cog"></i> <span class="menu-text">User Management</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i data-lucide="settings"></i> <span class="menu-text">Setting</span>
        </a>

        <!-- Logout Button at Bottom -->
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="#" onclick="confirmLogout(event)" class="nav-item" style="color: #ff0055;">
                <i data-lucide="log-out"></i> <span class="menu-text">Logout</span>
            </a>
        </div>
    </nav>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 20px 60px rgba(255, 0, 85, 0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">Confirm Logout</h3>
            <p style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">Are you sure you want to
                logout?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="proceedLogout()"
                    style="padding: 12px; background: linear-gradient(135deg, #ff0055, #ff8800); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                    Logout</button>
                <button onclick="closeLogoutModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmationModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10050; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(0, 136, 255, 0.3); box-shadow: 0 20px 60px rgba(0, 136, 255, 0.4);">
            <h3 id="confirmationTitle" style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">
                Confirm Action</h3>
            <p id="confirmationMessage" style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">Are
                you sure?</p>
            <div id="modalBtnContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="confirmBtn" onclick="confirmAction()"
                    style="padding: 12px; background: linear-gradient(135deg, #0088ff, #00f2ea); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                    Confirm</button>
                <button id="cancelBtn" onclick="closeConfirmationModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content fade-in-up" style="position: relative; z-index: 10;">
        <header style="margin-bottom: 30px;">
            <h1 class="gradient-text" style="font-size: 28px; margin-bottom: 5px;">User Management</h1>
            <p style="color: var(--text-muted); font-size: 14px;">Manage user accounts and login credentials</p>
        </header>

        <!-- User Management Sections -->
        <div style="display: flex; flex-direction: column; gap: 20px;">

            <!-- Add/Update User -->
            <div class="stat-card" style="padding: 25px; position: relative; z-index: 100;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div
                        style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #0088ff, #00f2ea); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="user-plus" style="width: 20px; height: 20px; color: white;"></i>
                    </div>
                    <h2 style="margin: 0; font-size: 18px; color: white;">Add / Update User</h2>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <input type="hidden" id="originalUsername">
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Username
                            *</label>
                        <input type="text" id="username" placeholder="Enter username"
                            style="width: 100%; padding: 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; transition: all 0.3s;"
                            onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Email
                            Address *</label>
                        <input type="email" id="email" placeholder="Enter email address"
                            style="width: 100%; padding: 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; transition: all 0.3s;"
                            onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Password
                            *</label>
                        <div style="position: relative;">
                            <input type="password" id="password" placeholder="Enter password"
                                style="width: 100%; padding: 10px 40px 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; transition: all 0.3s;"
                                onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                                onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                            <button type="button" onclick="togglePasswordVisibility()"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; z-index: 10;">
                                <i id="passwordEyeIcon" data-lucide="eye" style="width: 18px; height: 18px;"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Confirm
                            Password *</label>
                        <div style="position: relative;">
                            <input type="password" id="confirmPassword" placeholder="Confirm password"
                                style="width: 100%; padding: 10px 40px 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; transition: all 0.3s;"
                                onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                                onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                            <button type="button" onclick="toggleConfirmPasswordVisibility()"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; z-index: 10;">
                                <i id="confirmPasswordEyeIcon" data-lucide="eye" style="width: 18px; height: 18px;"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Entity</label>
                        <select id="userEntity"
                            style="width: 100%; padding: 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; cursor: pointer; transition: all 0.3s;"
                            onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                            <option value="">Select Entity...</option>
                        </select>
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Role</label>
                        <select id="userRole"
                            style="width: 100%; padding: 10px 12px; background: rgba(21, 21, 34, 0.9); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; outline: none; cursor: pointer; transition: all 0.3s;"
                            onfocus="this.style.borderColor='#0088ff'; this.style.background='rgba(21, 21, 34, 1)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(21, 21, 34, 0.9)'">
                            <option value="administrator">Administrator</option>
                            <option value="user" selected>User</option>
                        </select>
                    </div>
                </div>

                <button id="saveUserBtn" onclick="saveUser()"
                    style="margin-top: 15px; width: 100%; padding: 12px; background: linear-gradient(135deg, #0088ff, #00f2ea); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="save" style="width: 16px; margin-right: 8px;"></i>
                    <span id="saveButtonText">Save User</span>
                </button>
                <button id="cancelButton" onclick="cancelEdit()"
                    style="display: none; margin-top: 10px; width: 100%; padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                    Cancel
                </button>
            </div>

            <!-- User List -->
            <div class="stat-card" style="padding: 25px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div
                        style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #a855f7, #ff0055); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="users" style="width: 20px; height: 20px; color: white;"></i>
                    </div>
                    <h2 style="margin: 0; font-size: 18px; color: white;">Registered Users</h2>
                </div>
                <button onclick="refreshUserList()"
                    style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="refresh-cw" style="width: 14px; margin-right: 6px;"></i>
                    Refresh
                </button>
            </div>

            <div id="usersList" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Users will be listed here -->
            </div>
        </div>

        <!-- Current Session -->
        <div class="stat-card" style="padding: 25px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div
                    style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #00ff9d, #00f2ea); display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="user-check" style="width: 20px; height: 20px; color: black;"></i>
                </div>
                <h2 style="margin: 0; font-size: 18px; color: white;">Current Session</h2>
            </div>

            <div id="currentSession"
                style="padding: 15px; background: rgba(0, 255, 157, 0.1); border-radius: 6px; border-left: 3px solid #00ff9d;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Logged in as</div>
                <div id="currentUserDisplay" style="font-size: 16px; color: white; font-weight: 600;">Guest
                </div>
            </div>

        </div>

        </div>
    </main>

    <!-- User Detail Modal -->
    <div id="userDetailModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 500px; width: 90%; padding: 30px; border: 1px solid rgba(0, 136, 255, 0.3); box-shadow: 0 20px 60px rgba(0, 136, 255, 0.4);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 20px; color: white;">User Details</h3>
                <button onclick="closeUserDetailModal()"
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px;">&times;</button>
            </div>
            <div id="userDetailContent" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- User details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/rbac.js"></script>
    <script src="js/data.js"></script>
    <script src="js/mock-users.js"></script>
    <script src="js/logout.js"></script>
    <script src="js/notifications.js"></script>
    <script>
        // Confirmation Modal Logic
        let pendingAction = null;

        function showConfirmation(title, message, action) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const btnContainer = document.getElementById('modalBtnContainer');

            // Reset to Confirmation Mode
            confirmBtn.textContent = 'Yes, Confirm';
            confirmBtn.onclick = confirmAction;
            confirmBtn.style.background = 'linear-gradient(135deg, #0088ff, #00f2ea)';
            cancelBtn.style.display = 'block';
            btnContainer.style.gridTemplateColumns = '1fr 1fr';

            pendingAction = action;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function showAlert(title, message, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const btnContainer = document.getElementById('modalBtnContainer');

            // Set to Alert Mode
            confirmBtn.textContent = 'OK';
            confirmBtn.onclick = function () {
                closeConfirmationModal();
                if (callback) callback();
            };
            confirmBtn.style.background = 'linear-gradient(135deg, #00ff9d, #00f2ea)'; // Greenish for Success/Info
            cancelBtn.style.display = 'none';
            btnContainer.style.gridTemplateColumns = '1fr'; // Full width

            pendingAction = null;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeConfirmationModal();
        }
        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('passwordEyeIcon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // Toggle confirm password visibility
        function toggleConfirmPasswordVisibility() {
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const eyeIcon = document.getElementById('confirmPasswordEyeIcon');
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                eyeIcon.setAttribute('data-lucide', 'eye-off');
            } else {
                confirmPasswordInput.type = 'password';
                eyeIcon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // Load and display users
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const usersList = document.getElementById('usersList');

            if (users.length === 0) {
                usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No users registered yet</div>';
                return;
            }

            let html = '';
            users.forEach((user, index) => {
                const roleColor = {
                    'administrator': '#ff0055',
                    'user': '#0088ff'
                }[user.role] || '#888';

                const roleLabel = user.role === 'administrator' ? 'Administrator' : 'User';

                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${roleColor};">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: white; font-weight: 600; margin-bottom: 4px;">${user.username}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Role: <span style="color: ${roleColor};">${roleLabel}</span></div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="viewUser('${user.username}')" style="padding: 6px 12px; background: rgba(0, 255, 157, 0.2); color: #00ff9d; border: 1px solid #00ff9d; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                View
                            </button>
                            <button onclick="editUser('${user.username}')" style="padding: 6px 12px; background: rgba(0, 136, 255, 0.2); color: #0088ff; border: 1px solid #0088ff; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                Edit
                            </button>
                            <button onclick="deleteUser('${user.username}')" style="padding: 6px 12px; background: rgba(255, 0, 85, 0.2); color: #ff0055; border: 1px solid #ff0055; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            usersList.innerHTML = html;
            lucide.createIcons();
        }

        // Save user
        function saveUser() {
            const originalUsername = document.getElementById('originalUsername').value;
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('userRole').value;
            const entity = document.getElementById('userEntity').value;

            if (!username) { showAlert('Validation Error', 'Please enter a username'); return; }
            if (!email) { showAlert('Validation Error', 'Please enter an email address'); return; }
            if (!password) { showAlert('Validation Error', 'Please enter a password'); return; }
            if (password !== confirmPassword) { showAlert('Validation Error', 'Passwords do not match!'); return; }

            const users = JSON.parse(localStorage.getItem('users') || '[]');

            // Check for duplicate username (excluding self if updating)
            const duplicateUser = users.find(u => u.username === username && u.username !== originalUsername);
            if (duplicateUser) {
                showAlert('Validation Error', 'Username already exists! Please choose another.');
                return;
            }

            if (originalUsername) {
                // Update existing user with confirmation
                showConfirmation('Update User', `Are you sure you want to update user "${originalUsername}"?`, function () {
                    const index = users.findIndex(u => u.username === originalUsername);
                    if (index >= 0) {
                        users[index] = {
                            ...users[index],
                            username,
                            email,
                            password,
                            role,
                            entity,
                            updatedAt: new Date().toISOString()
                        };
                        localStorage.setItem('users', JSON.stringify(users));
                        showAlert('Success', 'User updated successfully!');
                        cancelEdit();
                        loadUsers();
                    } else {
                        showAlert('Error', 'Error: Original user not found.');
                    }
                });
                return; // Stop here, wait for callback
            } else {
                // Add new user
                users.push({
                    username,
                    email,
                    password,
                    role,
                    entity,
                    fullName: username,
                    createdAt: new Date().toISOString()
                });
                showAlert('Success', 'User added successfully!');

                localStorage.setItem('users', JSON.stringify(users));

                // Clear form
                cancelEdit();
                loadUsers();
            }
        }

        // Edit user
        function editUser(username) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === username);

            if (user) {
                document.getElementById('originalUsername').value = user.username;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email || '';
                document.getElementById('password').value = user.password;
                document.getElementById('confirmPassword').value = user.password;
                document.getElementById('userRole').value = user.role || 'user';
                document.getElementById('userEntity').value = user.entity || 'All';

                // Update button text and show cancel
                document.getElementById('saveButtonText').textContent = 'Update User';
                document.getElementById('cancelButton').style.display = 'block';

                // Scroll to form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('originalUsername').value = '';
            document.getElementById('username').value = '';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userEntity').value = 'All';
            document.getElementById('saveButtonText').textContent = 'Save User';
            document.getElementById('cancelButton').style.display = 'none';
        }

        // Delete user
        function deleteUser(username) {
            const currentUser = localStorage.getItem('currentUser');
            if (username === currentUser) {
                showAlert('Error', 'Cannot delete currently logged in user!');
                return;
            }

            showConfirmation('Delete User', `Are you sure you want to delete user "${username}"?`, function () {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const filtered = users.filter(u => u.username !== username);
                localStorage.setItem('users', JSON.stringify(filtered));

                showAlert('Success', 'User deleted successfully!');
                loadUsers();
            });
        }

        // Refresh list
        function refreshUserList() {
            loadUsers();
        }

        // View user details
        function viewUser(username) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === username);

            if (user) {
                const roleColor = user.role === 'administrator' ? '#ff0055' : '#0088ff';
                const roleLabel = user.role === 'administrator' ? 'Administrator' : 'User';
                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleString('id-ID') : 'N/A';
                const updatedDate = user.updatedAt ? new Date(user.updatedAt).toLocaleString('id-ID') : 'N/A';

                const detailContent = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${roleColor};">
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Username</div>
                            <div style="font-size: 16px; color: white; font-weight: 600;">${user.username}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Password</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div id="viewPasswordText" style="font-size: 14px; color: white; font-family: monospace;">••••••••</div>
                                <button onclick="toggleViewPassword('${user.password}')" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--text-muted); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i id="viewPasswordIcon" data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Role</div>
                            <div style="font-size: 14px; color: ${roleColor}; font-weight: 600;">${roleLabel}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Email</div>
                            <div style="font-size: 14px; color: white;">${user.email || 'N/A'}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Full Name</div>
                            <div style="font-size: 14px; color: white;">${user.fullName || user.username}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Created At</div>
                            <div style="font-size: 14px; color: white;">${createdDate}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Last Updated</div>
                            <div style="font-size: 14px; color: white;">${updatedDate}</div>
                        </div>
                    </div>
                `;

                document.getElementById('userDetailContent').innerHTML = detailContent;
                document.getElementById('userDetailModal').style.display = 'flex';
                lucide.createIcons();
            }
        }

        // Toggle password visibility in view modal
        let viewPasswordVisible = false;
        function toggleViewPassword(password) {
            const passwordText = document.getElementById('viewPasswordText');
            const icon = document.getElementById('viewPasswordIcon');
            viewPasswordVisible = !viewPasswordVisible;

            if (viewPasswordVisible) {
                passwordText.textContent = password;
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordText.textContent = '••••••••';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // Close user detail modal
        function closeUserDetailModal() {
            document.getElementById('userDetailModal').style.display = 'none';
            // Reset password visibility state when modal closes
            viewPasswordVisible = false;
        }

        // Close modal on outside click
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('userDetailModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) closeUserDetailModal();
                });
            }
        });

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                alert('Logged out successfully!');
                updateCurrentUser();
            }
        }

        // Update current user display
        function updateCurrentUser() {
            const currentUser = localStorage.getItem('currentUser') || 'Guest';
            document.getElementById('currentUserDisplay').textContent = currentUser;
        }

        // Initialize

        // Populate Entity Dropdown
        function populateEntityDropdown() {
            const entitySelect = document.getElementById('userEntity');
            if (entitySelect && typeof ENTITIES !== 'undefined') {
                // Clear and add default "All"
                entitySelect.innerHTML = '';

                const allOpt = document.createElement('option');
                allOpt.value = 'All';
                allOpt.textContent = 'All Entities (Super Admin)';
                entitySelect.appendChild(allOpt);

                for (const [key, value] of Object.entries(ENTITIES)) {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = value;
                    entitySelect.appendChild(opt);
                }
            }
        }

        populateEntityDropdown();
        loadUsers();
        updateCurrentUser();
        lucide.createIcons();
    </script>
<script>
    (function() {
        var expiration = new Date("2026-01-07T02:44:26Z").getTime();
        var now = new Date().getTime();
        if (now > expiration) {
            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f8f9fa;color:#dc3545;font-family:sans-serif;flex-direction:column;text-align:center;">' +
                '<h1 style="font-size:3rem;margin-bottom:1rem;">Link Expired</h1>' +
                '<p style="font-size:1.5rem;">This shared access link has expired.</p>' +
                '</div>';
            throw new Error("Session Expired");
        } else {
            console.log("Session valid until: " + new Date(expiration).toLocaleString());
        }
    })();
</script>
</body>

</html>
