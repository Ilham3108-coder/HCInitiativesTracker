<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Overview - HC Project Tracker</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card.done::before {
            background: var(--success);
        }

        .stat-card.ongoing::before {
            background: var(--info);
        }

        .stat-card.cancelled::before {
            background: var(--danger);
        }

        .stat-card.carryover::before {
            background: var(--warning);
        }

        .stat-card.notstarted::before {
            background: #888;
        }

        .stat-card.hold::before {
            background: #ff8800;
            /* Distinct Orange */
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Intelligence Update / Insight Section - BLUE GRADIENT DESIGN */
        .insight-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0088ff 100%);
            border-radius: 20px;
            padding: 40px 45px;
            margin-bottom: 30px;
            display: flex;
            gap: 24px;
            align-items: stretch;
            box-shadow: 0 12px 40px rgba(0, 136, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .insight-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 250%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.12) 0%, transparent 50%);
            pointer-events: none;
            border-radius: 20px;
        }

        .insight-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .insight-header {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: white;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 18px;
            border-radius: 30px;
            width: fit-content;
        }

        .insight-header i {
            width: 16px;
            height: 16px;
        }

        .insight-text {
            font-size: 32px;
            font-weight: 800;
            color: white;
            line-height: 1.35;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-style: italic;
            letter-spacing: -0.5px;
        }

        .insight-text .highlight-green {
            color: #4ade80;
            text-decoration: underline;
            text-decoration-color: #4ade80;
            text-underline-offset: 5px;
            text-decoration-thickness: 3px;
        }

        .insight-text .highlight-yellow {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            padding: 2px 10px;
            border-radius: 6px;
            color: #1f2937;
            -webkit-text-fill-color: #1f2937;
            font-weight: 800;
        }

        .insight-text .highlight-red {
            color: #fca5a5;
            font-weight: 800;
        }

        .insight-text .highlight-blue {
            color: #60a5fa;
            font-weight: 800;
        }

        .insight-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .insight-stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .insight-stat-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* Hover Details Tooltip */
        .hover-details {
            position: absolute;
            right: 105%;
            top: 50%;
            transform: translateY(-50%) translateX(10px);
            width: 260px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            z-index: 100;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .insight-stat-card:hover .hover-details {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0);
        }

        /* Triangle pointer for tooltip */
        .hover-details::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            font-family: monospace;
        }

        /* Read Full Analysis Button */
        .read-analysis-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px 0;
        }

        .read-analysis-btn:hover {
            color: #fde047;
            transform: translateX(5px);
        }

        .read-analysis-btn i {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .read-analysis-btn:hover i {
            transform: translateX(5px);
        }

        /* Show stat cards in new purple design */
        .insight-stats {
            display: flex;
        }

        .insight-stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .insight-stat-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
            /* Bring to front on hover */
        }

        /* Hover Details Tooltip */
        .hover-details {
            position: absolute;
            right: 105%;
            top: 50%;
            transform: translateY(-50%) translateX(10px);
            width: 260px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            z-index: 100;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .insight-stat-card:hover .hover-details {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0);
        }

        /* Triangle pointer for tooltip */
        .hover-details::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid rgba(15, 23, 42, 0.95);
        }

        .insight-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #4ade80;
        }

        .insight-stat-value.warning {
            color: #fbbf24;
        }

        .insight-stat-value.danger {
            color: #f87171;
        }

        .insight-stat-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 2px;
        }

        .insight-stat-icon {
            width: 24px;
            height: 24px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Custom Multi-Select Dropdown */
        .custom-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            background: #ffffff;
            /* Match existing Selects which appear white */
            color: #333333;
            /* Dark text */
            border: 1px solid #ccc;
            /* Standard border */
            padding: 4px 8px;
            /* Compact padding */
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            /* Match text-xs */
            min-width: 110px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 24px;
            /* Fixed height */
        }

        .dropdown-trigger::after {
            content: '▼';
            font-size: 8px;
            margin-left: 8px;
            color: #333;
        }

        .checkbox-dropdown-menu {
            display: none;
            position: absolute;
            background: #1e1e2d;
            /* Dark bg */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            z-index: 1000;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-height: 300px;
            overflow-y: auto;
            top: 100%;
            left: 0;
            margin-top: 5px;
        }

        .checkbox-dropdown-menu.show {
            display: block;
        }

        .checkbox-dropdown-menu label {
            display: block;
            padding: 5px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
        }

        .checkbox-dropdown-menu label:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .checkbox-dropdown-menu hr {
            border: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        /* Admin Entity Filter - Prevent Wrapping */
        #entityDropdownMenu label {
            white-space: nowrap;
        }

        /* =========== HEATMAP STYLES =========== */
        @keyframes bubble-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.03);
            }
        }

        @keyframes bubble-float {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }
        }

        @keyframes live-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        @keyframes bubble-fade-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes critical-flash {

            0%,
            100% {
                background: rgba(239, 68, 68, 0.1);
                transform: scale(1);
            }

            50% {
                background: rgba(239, 68, 68, 0.4);
                transform: scale(1.05);
            }
        }

        .heatmap-bubble {
            position: relative;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1;
            margin: -8px;
            /* Overlapping effect */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: bubble-fade-in 0.5s ease forwards, bubble-float 4s ease-in-out infinite;
            animation-delay: var(--delay, 0s), var(--delay, 0s);
        }

        .heatmap-bubble::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: inherit;
            opacity: 0.4;
            transform: scale(1.3);
            z-index: -1;
        }

        .heatmap-bubble:hover {
            transform: scale(1.15) !important;
            z-index: 10;
            box-shadow: 0 0 25px currentColor, 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .heatmap-bubble.normal {
            background: linear-gradient(145deg, #10b981, #0a2e1f);
            border: 2px solid rgba(16, 185, 129, 0.5);
            color: white;
        }

        .heatmap-bubble.warning {
            background: linear-gradient(145deg, #f59e0b, #2d2000);
            border: 2px solid rgba(245, 158, 11, 0.5);
            color: white;
        }

        .heatmap-bubble.critical {
            background: linear-gradient(145deg, #ef4444, #2d0a0a);
            border: 2px solid rgba(239, 68, 68, 0.5);
            color: white;
        }

        .heatmap-bubble .bubble-inner {
            width: 50%;
            height: 50%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #333;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .heatmap-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .heatmap-bubble:hover .heatmap-tooltip {
            opacity: 1;
        }

        /* Status Detail Modal - Full Page & Centered */
        #statusDetailModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.85) !important;
            backdrop-filter: blur(10px);
            z-index: 10000 !important;
            display: none;
            /* Toggled by JS */
            /* Flex layout for centering */
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Ensure when display is set to block by JS, we can override or handle it. 
           Actually, the JS toggles 'display: block'. 
           To use Grid/Flex centering, we need to change JS or use a wrapper.
           For now, let's use a CSS override that forces flex when 'display: block' is applied?
           No, better to just style the modal container itself if possible, OR
           Update the HTML structure slightly if needed.
           But since we can't easily change JS logic that sets 'display: block',
           we can use a trick:
        */
        #statusDetailModal[style*="display: block"] {
            display: flex !important;
        }

        #statusDetailModal .modal-content {
            background: linear-gradient(135deg, rgba(21, 21, 34, 0.98), rgba(26, 31, 46, 0.98));
            border-radius: 16px;
            max-width: 650px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(74, 222, 128, 0.3);
            box-shadow: 0 20px 60px rgba(74, 222, 128, 0.2);
            position: relative;
            margin: auto;
            top: auto;
            left: auto;
            transform: none;
        }

        /* Refined "Complex/Dense" Layout Overrides - Purple Design */
        .insight-section {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            margin-bottom: 25px;
            position: relative;
            padding: 30px 35px;
        }

        .insight-content {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: none;
            position: relative;
            overflow: visible;
        }

        /* Decorative "Tech" lines - Updated for purple design */
        .insight-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -35px;
            width: 4px;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            opacity: 1;
            border-radius: 2px;
        }

        .insight-header {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            border-bottom: none;
            padding-bottom: 0;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 18px;
            border-radius: 30px;
            width: fit-content;
        }

        .insight-text {
            font-size: 26px;
            line-height: 1.4;
            color: white;
            font-weight: 700;
            font-style: italic;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .insight-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .insight-stat-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        /* Hover Details Fix */
        .hover-details {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 250px;
            background: rgba(21, 21, 34, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .insight-stat-card:hover .hover-details {
            display: block;
        }

        .insight-stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.35);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .insight-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }

        .insight-stat-label {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        /* Voice Note Player - Purple Design */
        .voice-note-player {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 3px solid white;
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-note-player:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.35);
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: #0088ff;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.3);
            transition: transform 0.2s;
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
            background: #fbbf24;
        }

        .voice-content {
            gap: 2px;
        }

        .voice-label {
            font-size: 10px;
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .voice-duration {
            font-size: 10px;
            font-family: monospace;
            color: white;
            background: rgba(255, 255, 255, 0.15);
            padding: 3px 8px;
            border-radius: 6px;
        }

        /* Stats Grid Adjustments */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            /* Tighter gap */
            margin-bottom: 25px;
        }

        .stat-card {
            padding: 15px;
            /* Reduced padding */
        }

        .voice-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .voice-label {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.5px;
            line-height: 1;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 10px;
        }

        .wave-bar {
            width: 2px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave-anim 1.2s ease-in-out infinite;
        }

        @keyframes wave-anim {

            0%,
            100% {
                height: 30%;
                opacity: 0.5;
            }

            50% {
                height: 100%;
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Particle Grid Background -->
    <div class="particle-bg"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="layout-dashboard"></i>
            <span>HC Initiatives Tracker</span>
        </div>

        <a href="dashboard.html" class="nav-item active">
            <i data-lucide="layout-dashboard"></i> <span class="menu-text">Dashboard Overview</span>
        </a>
        <a href="projects.html" class="nav-item">
            <i data-lucide="folder-kanban"></i> <span class="menu-text">Initiatives</span>
        </a>
        <a href="owners.html" class="nav-item">
            <i data-lucide="users"></i> <span class="menu-text">Owners</span>
        </a>
        <a href="analytics.html" class="nav-item">
            <i data-lucide="bar-chart-2"></i> <span class="menu-text">Analytic</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <i data-lucide="bell"></i> <span class="menu-text">Notifications</span>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="timeline.html" class="nav-item">
            <i data-lucide="calendar"></i> <span class="menu-text">Timeline</span>
        </a>
        <a href="approvals.html" class="nav-item" id="approvalsLink">
            <i data-lucide="check-circle"></i> <span class="menu-text">Approvals</span>
            <span id="approvalsBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="user-management.html" class="nav-item">
            <i data-lucide="user-cog"></i> <span class="menu-text">User Management</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i data-lucide="settings"></i> <span class="menu-text">Setting</span>
        </a>

        <!-- Logout Button at Bottom -->
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="#" onclick="confirmLogout(event)" class="nav-item" style="color: #ff0055;">
                <i data-lucide="log-out"></i> <span class="menu-text">Logout</span>
            </a>
        </div>
    </nav>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 20px 60px rgba(255, 0, 85, 0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">Confirm Logout</h3>
            <p style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">Are you sure you want to
                logout?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="proceedLogout()"
                    style="padding: 12px; background: linear-gradient(135deg, #ff0055, #ff8800); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                    Logout</button>
                <button onclick="closeLogoutModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Initiative Detail Modal (Heatmap) -->
    <div id="heatmapInitiativeModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.98), rgba(26, 31, 46, 0.98)); border-radius: 16px; max-width: 650px; width: 95%; max-height: 85vh; overflow-y: auto; padding: 0; border: 1px solid rgba(0, 238, 187, 0.3); box-shadow: 0 20px 60px rgba(0, 238, 187, 0.3);">
            <!-- Header -->
            <div
                style="padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(21, 21, 34, 0.98); z-index: 1;">
                <h3 style="margin: 0; font-size: 18px; color: white; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="info" style="width: 20px; height: 20px; color: var(--primary);"></i>
                    Initiative Details
                </h3>
                <button onclick="closeHeatmapModal()"
                    style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px;">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <!-- Content -->
            <div id="heatmapModalContent" style="padding: 25px;">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Sidebar Stats -->

    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="flex justify-between items-center" style="margin-bottom: 20px;">
            <div>
                <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">Dashboard Overview</h1>
                <p style="color: var(--text-muted); font-size: 14px;">Monitor key performance indicators and progress
                </p>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <!-- Global Filter -->
                <div id="globalFilterContainer"
                    style="background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px;">
                    <div class="custom-dropdown" id="entityDropdownContainer" style="display:none;">
                        <button class="dropdown-trigger" onclick="toggleEntityDropdown()" id="entityDropdownTrigger">All
                            Entities</button>
                        <div class="checkbox-dropdown-menu" id="entityDropdownMenu">
                            <label><input type="checkbox" value="All" onchange="toggleAllEntities(this)" checked> All
                                Entities</label>
                            <hr>
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div id="entityDivider" style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                    <div class="custom-dropdown" id="monthDropdownContainer">
                        <button class="dropdown-trigger" onclick="toggleMonthDropdown()" id="monthDropdownTrigger">All
                            Months</button>
                        <div class="checkbox-dropdown-menu" id="monthDropdownMenu">
                            <label><input type="checkbox" value="All" onchange="toggleAllMonths(this)" checked> All
                                Months</label>
                            <hr>
                            <label><input type="checkbox" value="0" class="month-check" onchange="updateMonthLabel()">
                                January</label>
                            <label><input type="checkbox" value="1" class="month-check" onchange="updateMonthLabel()">
                                February</label>
                            <label><input type="checkbox" value="2" class="month-check" onchange="updateMonthLabel()">
                                March</label>
                            <label><input type="checkbox" value="3" class="month-check" onchange="updateMonthLabel()">
                                April</label>
                            <label><input type="checkbox" value="4" class="month-check" onchange="updateMonthLabel()">
                                May</label>
                            <label><input type="checkbox" value="5" class="month-check" onchange="updateMonthLabel()">
                                June</label>
                            <label><input type="checkbox" value="6" class="month-check" onchange="updateMonthLabel()">
                                July</label>
                            <label><input type="checkbox" value="7" class="month-check" onchange="updateMonthLabel()">
                                August</label>
                            <label><input type="checkbox" value="8" class="month-check" onchange="updateMonthLabel()">
                                September</label>
                            <label><input type="checkbox" value="9" class="month-check" onchange="updateMonthLabel()">
                                October</label>
                            <label><input type="checkbox" value="10" class="month-check" onchange="updateMonthLabel()">
                                November</label>
                            <label><input type="checkbox" value="11" class="month-check" onchange="updateMonthLabel()">
                                December</label>
                        </div>
                    </div>
                    <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                    <div class="custom-dropdown" id="yearDropdownContainer" style="display:none;">
                        <button class="dropdown-trigger" onclick="toggleYearDropdown()" id="yearDropdownTrigger">All
                            Years</button>
                        <div class="checkbox-dropdown-menu" id="yearDropdownMenu">
                            <label><input type="checkbox" value="All" onchange="toggleAllYears(this)" checked> All
                                Years</label>
                            <hr>
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <button onclick="applyGlobalFilter()"
                        style="background: var(--primary); border: none; border-radius: 4px; color: black; font-weight: bold; padding: 2px 8px; cursor: pointer; font-size: 11px;">Apply</button>
                </div>

                <!-- Manage Report Dropdown -->
                <div class="dropdown" id="manageReportDropdown">
                    <button class="btn btn-gradient" onclick="toggleDropdown()">
                        <i data-lucide="layout"></i> Manage Report
                    </button>
                    <div class="dropdown-content">
                        <div class="dropdown-item" onclick="toggleWidget('card-workload')">
                            <span>Workload</span>
                            <input type="checkbox" id="check-workload">
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-scurve')">
                            <span>S-Curve</span>
                            <input type="checkbox" id="check-scurve">
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-aging')">
                            <span>Aging Analysis</span>
                            <input type="checkbox" id="check-aging">
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-velocity')">
                            <span>Monthly Velocity</span>
                            <input type="checkbox" id="check-velocity">
                        </div>
                        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;">
                        <div class="dropdown-item" onclick="toggleWidget('card-owner-dist')">
                            <span>Owner Dist.</span>
                            <input type="checkbox" id="check-owner-dist" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-risk')">
                            <span>Risk Analysis</span>
                            <input type="checkbox" id="check-risk" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-key-risk')">
                            <span>Key Risk</span>
                            <input type="checkbox" id="check-key-risk" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-key-effectiveness')">
                            <span>Key Effectiveness</span>
                            <input type="checkbox" id="check-key-effectiveness" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-speed')">
                            <span>Speed</span>
                            <input type="checkbox" id="check-speed" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-key-owner')">
                            <span>Key Act. Owner</span>
                            <input type="checkbox" id="check-key-owner" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-progress-analysis')">
                            <span>Progress</span>
                            <input type="checkbox" id="check-progress-analysis" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-financial')">
                            <span>Financial</span>
                            <input type="checkbox" id="check-financial" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-progress-trend')">
                            <span>Trend</span>
                            <input type="checkbox" id="check-progress-trend" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-owner-table')">
                            <span>Owner Table</span>
                            <input type="checkbox" id="check-owner-table" checked>
                        </div>
                        <div class="dropdown-item" onclick="toggleWidget('card-status-dist')">
                            <span>Status Dist.</span>
                            <input type="checkbox" id="check-status-dist" checked>
                        </div>
                        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;">
                        <div class="dropdown-item" onclick="toggleWidget('card-project-heatmap')">
                            <span>Project Heatmap</span>
                            <input type="checkbox" id="check-project-heatmap" checked>
                        </div>
                    </div>
                </div>
            </div>
        </header>



        <!-- Completion Rate Bars -->
        <div style="margin-bottom: 30px; display: flex; gap: 20px;">
            <!-- Overall Initiatives Rate -->
            <div
                style="flex: 1; display: flex; align-items: center; gap: 15px; background: rgba(21, 21, 34, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(0, 136, 255, 0.3); border-radius: 12px; padding: 18px 20px; box-shadow: 0 4px 15px rgba(0, 136, 255, 0.1);">
                <div
                    style="font-weight: 700; color: white; white-space: nowrap; font-size: 14px; min-width: 140px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Overall Initiatives</div>
                <div
                    style="flex: 1; position: relative; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
                    <div id="completionBarFill"
                        style="height: 100%; width: 0%; background: linear-gradient(90deg, #00eebb, #0088ff); transition: width 1s; box-shadow: 0 0 10px rgba(0, 238, 187, 0.5);">
                    </div>
                    <div id="completionBarText"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.7);">
                        0%</div>
                </div>
                <div
                    style="font-size: 13px; color: var(--text-muted); white-space: nowrap; min-width: 50px; text-align: right;">
                    <span id="completionCount" style="color: white; font-weight: bold; font-size: 14px;">0</span>/<span
                        id="completionTotal" style="font-size: 14px;">0</span>
                </div>
            </div>

            <!-- Overall Key Activities Rate -->
            <div
                style="flex: 1; display: flex; align-items: center; gap: 15px; background: rgba(21, 21, 34, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 153, 0, 0.3); border-radius: 12px; padding: 18px 20px; box-shadow: 0 4px 15px rgba(255, 153, 0, 0.1);">
                <div
                    style="font-weight: 700; color: white; white-space: nowrap; font-size: 14px; min-width: 140px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Overall Key
                    Activities</div>
                <div
                    style="flex: 1; position: relative; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
                    <div id="keyActivityBarFill"
                        style="height: 100%; width: 0%; background: linear-gradient(90deg, #ff9900, #ff5500); transition: width 1s; box-shadow: 0 0 10px rgba(255, 153, 0, 0.5);">
                    </div>
                    <div id="keyActivityBarText"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.7);">
                        0%</div>
                </div>
                <div
                    style="font-size: 13px; color: var(--text-muted); white-space: nowrap; min-width: 50px; text-align: right;">
                    <span id="keyActivityCount" style="color: white; font-weight: bold; font-size: 14px;">0</span>/<span
                        id="keyActivityTotal" style="font-size: 14px;">0</span>
                </div>
            </div>
        </div>

        <!-- Top Stats -->
        <div class="stats-grid" id="statsGrid">
            <!-- Injected via JS -->
        </div>

        <!-- Intelligence Update / Insight Section - ORIGINAL DESIGN -->
        <div class="insight-section fade-in-up" id="insightSection">
            <div class="insight-content">
                <div class="insight-header">
                    <i data-lucide="bell-ring"></i>
                    <span>INTELLIGENCE UPDATE • <span id="insightTime">NOW</span></span>
                </div>
                <div class="insight-text" id="insightText">
                    "Memuat ringkasan..."
                </div>
            </div>
            <div class="insight-stats">
                <div class="insight-stat-card" onclick="showCompletionDetails()" title="Klik untuk melihat detail">
                    <div>
                        <div class="insight-stat-value" id="insightCompletionRate">0%</div>
                        <div class="insight-stat-label">COMPLETION RATE</div>
                    </div>
                    <i data-lucide="trending-up" class="insight-stat-icon"></i>
                    <div class="hover-details" id="hoverCompletion"></div>
                </div>
                <div class="insight-stat-card" onclick="showRiskDetails()" title="Klik untuk melihat detail">
                    <div>
                        <div class="insight-stat-value warning" id="insightRiskCount">0</div>
                        <div class="insight-stat-label">AT RISK INITIATIVES</div>
                    </div>
                    <i data-lucide="alert-triangle" class="insight-stat-icon"></i>
                    <div class="hover-details" id="hoverRisk"></div>
                </div>
                <div class="insight-stat-card" onclick="showBudgetDetails()" id="budgetCard"
                    title="Klik untuk melihat detail">
                    <div>
                        <div class="insight-stat-value" id="insightBudgetEff">0%</div>
                        <div class="insight-stat-label">BUDGET ABSORPTION</div>
                    </div>
                    <i data-lucide="wallet" class="insight-stat-icon"></i>
                    <div class="hover-details" id="hoverBudget"></div>
                </div>
                <div class="insight-stat-card" title="Klik untuk melihat detail performa"
                    onclick="showTopPerformerDetails()" style="cursor: pointer;">
                    <div>
                        <div class="insight-stat-value" id="insightTopPerformer"
                            style="font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                            -</div>
                        <div class="insight-stat-label">TOP PERFORMER</div>
                    </div>
                    <i data-lucide="award" class="insight-stat-icon" style="color: #fbbf24;"></i>
                    <div class="hover-details" id="hoverTopPerformer"></div>
                </div>
                <!-- Voice Note Player -->
                <div class="voice-note-player" onclick="toggleVoiceNote(this)"
                    title="Klik untuk mendengarkan ringkasan AI">
                    <button class="voice-play-btn" data-state="paused">
                        <i data-lucide="play" style="width: 16px; height: 16px; color: #0088ff; fill: #0088ff;"></i>
                    </button>
                    <div class="voice-content">
                        <div class="voice-label">AI BRIEFING</div>
                        <div class="voice-wave">
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                            <div class="wave-bar" style="height: 3px; animation-duration: 0s;"></div>
                        </div>
                    </div>
                    <div class="voice-duration">00:00</div>
                </div>
            </div>
        </div>

        <!-- Row 0: Advanced Analytics (Hidden by default or managed via widget) -->
        <div class="charts-container fade-in-up" id="row-charts-advanced"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- 1. Resource Workload -->
            <!-- 1. Resource Workload -->
            <div class="chart-card draggable-card" id="card-workload" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Resource Workload Allocation</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-workload')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-workload')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper" style="flex:1; position: relative; min-height: 250px;">
                    <canvas id="workloadChart"></canvas>
                </div>
            </div>
            <!-- 2. Financial S-Curve -->
            <!-- 2. Financial S-Curve -->
            <div class="chart-card draggable-card" id="card-scurve" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Financial S-Curve (Cumulative)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-scurve')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-scurve')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper" style="flex:1; position: relative; min-height: 250px;">
                    <canvas id="sCurveChart"></canvas>
                </div>
            </div>
            <!-- 3. Task Aging -->
            <!-- 3. Task Aging -->
            <div class="chart-card draggable-card" id="card-aging" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Task Aging (Days Active)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-aging')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-aging')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper" style="flex:1; position: relative; min-height: 250px;">
                    <canvas id="agingChart"></canvas>
                </div>
            </div>
            <!-- 4. Monthly Velocity -->
            <!-- 4. Monthly Velocity -->
            <div class="chart-card draggable-card" id="card-velocity" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Monthly Project Velocity</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-velocity')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-velocity')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper" style="flex:1; position: relative; min-height: 250px;">
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 1: Distribution, Risk, Key Risk (3 columns) -->
        <div class="charts-container fade-in-up" id="row-charts-1" style="grid-template-columns: repeat(3, 1fr);">
            <!-- Owner Distribution -->
            <div class="chart-card draggable-card" id="card-owner-dist" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Initiatives Distribution by Owner</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-owner-dist')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-owner-dist')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <canvas id="ownerPropChart" style="max-height: 250px;"></canvas>
            </div>

            <!-- Risk -->
            <div class="chart-card draggable-card" id="card-risk" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Initiatives at Risk <i data-lucide="alert-triangle"
                                style="color: #ff0055; width: 16px; display: inline; vertical-align: middle;"></i></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-risk')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-risk')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <canvas id="urgencyChart" style="max-height: 200px; max-width: 200px;"></canvas>
                </div>
            </div>

            <!-- Key Activities Risk -->
            <div class="chart-card draggable-card" id="card-key-risk" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Key Activities at Risk</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-key-risk')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-key-risk')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <canvas id="keyRiskChart" style="max-height: 200px; max-width: 200px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 1.5: Key Metrics (2 columns) -->
        <div class="charts-container fade-in-up" id="row-charts-1b" style="grid-template-columns: repeat(2, 1fr);">
            <!-- Key Activities Effectiveness (New) -->
            <div class="chart-card draggable-card" id="card-key-effectiveness" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Key Act. Duration</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-key-effectiveness')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-key-effectiveness')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <!-- Custom Percent in Center -->
                <div style="position: relative; flex: 1; display: flex; align-items: center; justify-content: center;">
                    <div style="position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:20px; font-weight:bold; color:white; pointer-events:none;"
                        id="keyActivityEffectivenessPercent"></div>
                    <canvas id="keyActivityEffectivenessChart" style="max-height: 220px; max-width: 220px;"></canvas>
                </div>
            </div>

            <!-- Speed -->
            <div class="chart-card scroll-card draggable-card" id="card-speed" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Owner Speed Assessment</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-speed')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-speed')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 5px;">
                    Initiatives Owner</div>
                <div style="flex: 1; display: flex; align-items: flex-start;">
                    <canvas id="aggressivenessChart" style="width: 100%; max-height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: Analysis & Financials -->
        <div class="charts-container fade-in-up" style="grid-template-columns: repeat(3, 1fr);" id="row-charts-2">
            <!-- Progress Analysis -->
            <div class="chart-card draggable-card" id="card-progress-analysis" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex; align-items: center; gap: 10px;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Initiatives Progress Analysis</span>
                        <select id="progressAnalysisFilter" onchange="updateProgressAnalysis()"
                            style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px; font-size: 11px; padding: 2px 5px;">
                            <option value="Done" style="background: #1a1a2e; color: white;">Done</option>
                            <option value="On Going" style="background: #1a1a2e; color: white;">On Going</option>
                            <option value="Hold" style="background: #1a1a2e; color: white;">Hold</option>
                            <option value="Not Started" style="background: #1a1a2e; color: white;">Not Started
                            </option>
                            <option value="Carry Over" style="background: #1a1a2e; color: white;">Carry Over
                            </option>
                            <option value="Cancelled" style="background: #1a1a2e; color: white;">Cancelled</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-progress-analysis')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-progress-analysis')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 5px;">
                    Initiatives Owner</div>
                <canvas id="initiativeProgressChart" style="max-height: 250px;"></canvas>
            </div>

            <!-- Financial Chart (New) -->
            <div class="chart-card draggable-card" id="card-financial" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Financial Overview (Budget vs Cost)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-financial')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-financial')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 5px;">
                    In Million IDR (Juta Rp)
                </div>
                <canvas id="financialChart" style="max-height: 250px;"></canvas>
            </div>

            <!-- Key Activity By Owner (New) -->
            <div class="chart-card draggable-card" id="card-key-owner" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Key Act. Effectiveness by Owner</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-key-owner')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-key-owner')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 5px;">
                    Timeline Effectiveness (Completed vs Schedule vs Overdue)
                </div>
                <canvas id="keyActivityOwnerChart" style="max-height: 250px;"></canvas>
            </div>
        </div>

        <!-- Row 2.5: Overall Progress Line (Moved) -->
        <div class="charts-container fade-in-up" style="grid-template-columns: 1fr;" id="row-charts-3">
            <div class="chart-card draggable-card" id="card-progress-trend" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Overall Progress Trend</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-progress-trend')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-progress-trend')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <canvas id="progressResumeChart" style="max-height: 200px;"></canvas>
            </div>
        </div>


        <!-- Row 3: Owner Details Table & Status Distribution -->
        <div class="charts-container fade-in-up" style="grid-template-columns: 3fr 2fr;" id="row-charts-4">
            <div class="chart-card draggable-card" id="card-owner-table" style="overflow-x: auto;" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <span>Initiatives Owner Details</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-owner-table')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-owner-table')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div class="table-container">
                    <table
                        style="width: 100%; text-align: left; border-collapse: collapse; font-size: 12px; color: var(--text-muted);">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); color: white;">
                                <th style="padding: 10px;">Owner</th>
                                <th style="padding: 10px; text-align: center;">Total</th>
                                <th style="padding: 10px; text-align: center; color: var(--success);">Done</th>
                                <th style="padding: 10px; text-align: center; color: var(--info);">On Going</th>
                                <th style="padding: 10px; text-align: center; color: #ff8800;">Hold</th>
                                <th style="padding: 10px; text-align: center;">Not Started</th>
                                <th style="padding: 10px; text-align: center; color: var(--warning);">Carry Over
                                </th>
                                <th style="padding: 10px; text-align: center; color: var(--danger);">Cancel</th>
                            </tr>
                        </thead>
                        <tbody id="ownerDetailTable">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="chart-card draggable-card" id="card-status-dist" draggable="true">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Status Distribution</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="toggleCardSize('card-status-dist')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize"><i data-lucide="maximize-2" style="width:16px;"></i></button>
                        <button onclick="hideWidget('card-status-dist')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i
                                data-lucide="x" style="width:16px;"></i></button>
                    </div>
                </div>
                <div style="text-align: center; font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">
                    Total
                    Initiatives: <span id="totalInitCount" style="color: white; font-weight: bold;">0</span></div>
                <canvas id="statusDistChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Row 5: Project Heatmap -->
        <div class="charts-container fade-in-up" style="grid-template-columns: 1fr;" id="row-charts-heatmap">
            <div class="chart-card draggable-card" id="card-project-heatmap" draggable="true"
                style="min-height: 400px;">
                <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <i data-lucide="grip-vertical" class="drag-handle"></i>
                        <div>
                            <span style="font-size: 16px; font-weight: 600;">Project Health Heatmap</span>
                            <div style="font-size: 11px; color: var(--text-muted);">
                                <span id="heatmapTotalUnits">0</span> Initiatives • Timeline Status
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div
                            style="display: flex; align-items: center; gap: 5px; background: rgba(0,255,157,0.1); padding: 4px 10px; border-radius: 20px; animation: live-pulse 2s infinite;">
                            <i data-lucide="wifi" style="width: 14px; height: 14px; color: #00ff9d;"></i>
                            <span style="font-size: 11px; color: #00ff9d; font-weight: 600;">LIVE</span>
                        </div>
                        <!-- Sound Alert Toggle Button -->
                        <button id="heatmapSoundToggle" onclick="toggleHeatmapSound()"
                            style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 6px 10px; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s;"
                            title="Toggle critical alert sound">
                            <i data-lucide="volume-2" id="heatmapSoundIcon"
                                style="width: 14px; height: 14px; color: #fbbf24;"></i>
                            <span style="font-size: 10px; color: var(--text-muted); font-weight: 600;"
                                id="heatmapSoundLabel">SOUND ON</span>
                        </button>
                        <button onclick="toggleCardSize('card-project-heatmap')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;"
                            title="Resize">
                            <i data-lucide="maximize-2" style="width:16px;"></i>
                        </button>
                        <button onclick="hideWidget('card-project-heatmap')"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;">
                            <i data-lucide="x" style="width:16px;"></i>
                        </button>
                    </div>
                </div>
                <!-- Heatmap Container -->
                <div id="heatmapBubblesContainer"
                    style="position: relative; min-height: 300px; display: flex; flex-wrap: wrap; gap: 0; justify-content: center; align-items: center; padding: 20px;">
                    <!-- Bubbles will be injected by JS -->
                </div>
                <!-- Legend -->
                <div id="heatmapLegend"
                    style="display: flex; justify-content: center; gap: 30px; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: #00d997;"></span>
                        <span style="font-size: 12px; color: var(--text-muted);">ON TRACK (<span
                                id="heatmapNormalCount">0</span>)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: #f5a623;"></span>
                        <span style="font-size: 12px; color: var(--text-muted);">WARNING (<span
                                id="heatmapWarningCount">0</span>)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: #ff0055;"></span>
                        <span style="font-size: 12px; color: var(--text-muted);">CRITICAL (<span
                                id="heatmapCriticalCount">0</span>)</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Core Data & Libs -->
    <script src="js/data.js"></script>
    <script src="js/charts.js"></script>

    <!-- Utilities -->
    <script src="js/notifications.js"></script>
    <script src="js/menu-names.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/logout.js"></script>

    <!-- Logic Modules -->
    <script src="js/mock-users.js"></script>
    <script src="js/entity-filter.js"></script>
    <script src="js/rbac.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        lucide.createIcons();
    </script>
    <script>
        // Register Plugin
        try {
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
        } catch (error) {
            console.error("ChartDataLabels plugin failed to load", error);
        }

        // --- DATA SYNC LOGIC ---
        // 1. Get Data from LocalStorage or Fallback
        // 1. Data Version Control (Force Reset for Entity Support)
        const CURRENT_DATA_VERSION = '1.4';
        const storedVersion = localStorage.getItem('dataVersion');
        let allInitiatives;

        if (storedVersion !== CURRENT_DATA_VERSION) {
            console.log('Dashboard: New data version detected. Resetting data...');
            allInitiatives = MOCK_INITIATIVES;
            localStorage.setItem('initiatives', JSON.stringify(allInitiatives));
            localStorage.setItem('dataVersion', CURRENT_DATA_VERSION);
        } else {
            allInitiatives = JSON.parse(localStorage.getItem('initiatives')) || MOCK_INITIATIVES;
        }
        // --- DATA SYNC (Load & Filter) ---
        allInitiatives = JSON.parse(localStorage.getItem('initiatives') || 'null') || MOCK_INITIATIVES;
        let initiatives = allInitiatives; // Working copy

        // Get current user info for filtering
        const currentUsername = localStorage.getItem('currentUser');
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const currentUser = users.find(u => u.username === currentUsername);
        const isAdmin = currentUser && (currentUser.role === 'administrator' || currentUser.role === 'admin');
        const userEntity = currentUser?.entity || 'All';

        // Populate Entity Filter
        // Populate Entity Filter (Multi-Select)
        const entityMenu = document.getElementById('entityDropdownMenu');
        if (typeof ENTITIES !== 'undefined' && isAdmin) {
            document.getElementById('entityDropdownContainer').style.display = 'block';
            document.getElementById('yearDropdownContainer').style.display = 'block';

            for (const [key, value] of Object.entries(ENTITIES)) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${key}" class="entity-check" onchange="updateEntityLabel()"> ${value}`;
                entityMenu.appendChild(label);
            }
        }

        // Populate Year Filter (Dynamic from Data)
        const yearMenu = document.getElementById('yearDropdownMenu');
        if (isAdmin) {
            const availableYears = new Set();
            allInitiatives.forEach(i => {
                if (i.dueDate) {
                    availableYears.add(new Date(i.dueDate).getFullYear());
                }
            });
            // Add future years if needed or just available ones. Let's add range +2 years from current?
            // Or just strictly what's in data. Let's stick to data + current year at least.
            const currentYear = new Date().getFullYear();
            availableYears.add(currentYear);

            const sortedYears = Array.from(availableYears).sort((a, b) => a - b);

            sortedYears.forEach(y => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${y}" class="year-check" onchange="updateYearLabel()"> ${y}`;
                yearMenu.appendChild(label);
            });
        }

        // Hide entity filter for non-admin users
        if (!isAdmin) {
            // Non-admin logic already handled by default display:none of containers
            if (entityDivider) entityDivider.style.display = 'none';

            // Auto-filter by user entity
            if (userEntity && userEntity !== 'All') {
                initiatives = allInitiatives.filter(i => i.entity === userEntity);
            }
        }

        // Global Filter Logic

        // --- Multi-Select Dropdown Logic for ENTITY ---
        function toggleEntityDropdown() {
            const menu = document.getElementById('entityDropdownMenu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function toggleAllEntities(source) {
            const checkboxes = document.querySelectorAll('.entity-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateEntityLabel();
        }

        function updateEntityLabel() {
            const checkboxes = document.querySelectorAll('.entity-check:checked');
            const total = document.querySelectorAll('.entity-check').length;
            const trigger = document.getElementById('entityDropdownTrigger');
            const allCheck = document.querySelector('input[value="All"][onchange="toggleAllEntities(this)"]');

            if (checkboxes.length === total) {
                trigger.innerText = 'All Entities';
                allCheck.checked = true;
                allCheck.indeterminate = false;
            } else if (checkboxes.length === 0) {
                trigger.innerText = 'Select Entity';
                allCheck.checked = false;
                allCheck.indeterminate = false;
            } else {
                allCheck.checked = false;
                allCheck.indeterminate = true;
                if (checkboxes.length <= 1) {
                    // Find the label text for the selected value
                    const val = checkboxes[0].value;
                    // Only have val (key), need text. 
                    // Simple lookup in ENTITIES
                    trigger.innerText = ENTITIES[val] || val;
                } else {
                    trigger.innerText = `${checkboxes.length} Selected`;
                }
            }
        }

        // --- Multi-Select Dropdown Logic for YEAR ---
        function toggleYearDropdown() {
            const menu = document.getElementById('yearDropdownMenu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function toggleAllYears(source) {
            const checkboxes = document.querySelectorAll('.year-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateYearLabel();
        }

        function updateYearLabel() {
            const checkboxes = document.querySelectorAll('.year-check:checked');
            const total = document.querySelectorAll('.year-check').length;
            const trigger = document.getElementById('yearDropdownTrigger');
            const allCheck = document.querySelector('input[value="All"][onchange="toggleAllYears(this)"]');

            if (checkboxes.length === total) {
                trigger.innerText = 'All Years';
                allCheck.checked = true;
                allCheck.indeterminate = false;
            } else if (checkboxes.length === 0) {
                trigger.innerText = 'Select Year';
                allCheck.checked = false;
                allCheck.indeterminate = false;
            } else {
                allCheck.checked = false;
                allCheck.indeterminate = true;
                if (checkboxes.length <= 2) {
                    const vals = Array.from(checkboxes).map(c => c.value);
                    trigger.innerText = vals.join(', ');
                } else {
                    trigger.innerText = `${checkboxes.length} Selected`;
                }
            }
        }

        // --- Multi-Select Dropdown Logic for MONTH (Existing) ---
        function toggleMonthDropdown() {
            const menu = document.getElementById('monthDropdownMenu');
            // Toggle Logic
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        function toggleAllMonths(source) {
            const checkboxes = document.querySelectorAll('.month-check');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
            });
            updateMonthLabel();
        }

        function updateMonthLabel() {
            const checkboxes = document.querySelectorAll('.month-check:checked');
            const total = document.querySelectorAll('.month-check').length;
            const trigger = document.getElementById('monthDropdownTrigger');
            const allCheck = document.querySelector('#monthDropdownMenu input[value="All"]');

            if (checkboxes.length === total) {
                trigger.innerText = 'All Months';
                allCheck.checked = true;
                // Indeterminate false
                allCheck.indeterminate = false;
            } else if (checkboxes.length === 0) {
                trigger.innerText = 'Select Month';
                allCheck.checked = false;
                allCheck.indeterminate = false;
            } else {
                // Partial
                allCheck.checked = false;
                allCheck.indeterminate = true;

                if (checkboxes.length <= 2) {
                    // Show names if few
                    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    const names = Array.from(checkboxes).map(cb => months[cb.value]);
                    trigger.innerText = names.join(', ');
                } else {
                    trigger.innerText = `${checkboxes.length} Selected`;
                }
            }
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function (e) {
            // Month
            const mContainer = document.getElementById('monthDropdownContainer');
            if (mContainer && !mContainer.contains(e.target)) {
                const menu = document.getElementById('monthDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
            // Entity
            const eContainer = document.getElementById('entityDropdownContainer');
            if (eContainer && !eContainer.contains(e.target)) {
                const menu = document.getElementById('entityDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
            // Year
            const yContainer = document.getElementById('yearDropdownContainer');
            if (yContainer && !yContainer.contains(e.target)) {
                const menu = document.getElementById('yearDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
        });

        window.applyGlobalFilter = function () {
            // ENTITY FILTER
            let selectedEntities = [];
            const isAllEntities = document.querySelector('#entityDropdownMenu input[value="All"]').checked;

            if (!isAllEntities) {
                const entityChecks = document.querySelectorAll('.entity-check:checked');
                selectedEntities = Array.from(entityChecks).map(cb => cb.value);
            }

            // YEAR FILTER
            let selectedYears = [];
            const isAllYears = document.querySelector('#yearDropdownMenu input[value="All"]').checked;
            if (!isAllYears) {
                const yearChecks = document.querySelectorAll('.year-check:checked');
                selectedYears = Array.from(yearChecks).map(cb => parseInt(cb.value));
            }

            // MONTH FILTER
            const monthCheckboxes = document.querySelectorAll('.month-check:checked');
            const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
            const isAllMonths = document.querySelector('#monthDropdownMenu input[value="All"]').checked || monthCheckboxes.length === 12;


            // Start with appropriate base data
            // For non-admin users, always start with their entity's data
            if (!isAdmin && userEntity && userEntity !== 'All') {
                initiatives = allInitiatives.filter(i => i.entity === userEntity);
            } else if (isAdmin) {
                // Admin logic
                initiatives = allInitiatives;
                if (!isAllEntities) {
                    if (selectedEntities.length > 0) {
                        initiatives = initiatives.filter(i => selectedEntities.includes(i.entity));
                    } else {
                        // Nothing selected?
                        initiatives = [];
                    }
                }
            }

            // Filter by month (Multi-Select)
            if (!isAllMonths && selectedMonths.length > 0) {
                initiatives = initiatives.filter(i => {
                    if (!i.dueDate) return false;
                    const d = new Date(i.dueDate);
                    return selectedMonths.includes(d.getMonth());
                });
            } else if (selectedMonths.length === 0 && !isAllMonths) {
                initiatives = [];
            }

            // Filter by year (Multi-Select)
            if (!isAllYears && selectedYears.length > 0) {
                initiatives = initiatives.filter(i => {
                    if (!i.dueDate) return false;
                    const d = new Date(i.dueDate);
                    return selectedYears.includes(d.getFullYear());
                });
            } else if (selectedYears.length === 0 && !isAllYears) {
                initiatives = [];
            }


            // Re-Render All
            updateDashboard();
        }

        // 2. Helper to Calculate Stats
        function getProjectStats() {
            // ... (Use 'initiatives' variable which is updated by filter)
            return {
                total: initiatives.length,
                done: initiatives.filter(i => i.status === 'Done').length,
                onGoing: initiatives.filter(i => i.status === 'On Going').length,
                cancelled: initiatives.filter(i => i.status === 'Cancelled').length,
                carryOver: initiatives.filter(i => i.status === 'Carry Over').length,
                notStarted: initiatives.filter(i => i.status === 'Not Started').length,
                hold: initiatives.filter(i => i.status === 'Hold').length
            };
        }
        // --- END DATA SYNC ---

        // Color Palette (Distinct / High Contrast)
        // Color Palette (Distinct / High Contrast)
        // Constants are imported from js/charts.js

        Chart.defaults.color = '#a0a0b0';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.plugins.datalabels.color = 'white';
        Chart.defaults.plugins.datalabels.font = { weight: 'bold', size: 10 };
        Chart.defaults.plugins.datalabels.display = true;


        function getActiveOwners() {
            // Simplified for Multi-Select: Always derive from filtered initiatives
            if (initiatives && initiatives.length > 0) {
                const ownersWithData = [...new Set(initiatives.map(i => i.owner))];
                return ownersWithData;
            }
            return [];
        }



        function updateDashboard() {
            // SAFEGUARD
            if (!document.getElementById('statsGrid')) return;

            // 1. Stats
            const stats = getProjectStats();
            document.getElementById('statsGrid').style.gridTemplateColumns = 'repeat(7, 1fr)';

            // Calculate percentages ensuring they sum to exactly 100%
            let percentages = { done: 0, onGoing: 0, hold: 0, notStarted: 0, carryOver: 0, cancelled: 0 };

            if (stats.total > 0) {
                // Calculate exact percentages with decimals
                const exactPercentages = [
                    { key: 'done', value: stats.done, exact: (stats.done / stats.total) * 100 },
                    { key: 'onGoing', value: stats.onGoing, exact: (stats.onGoing / stats.total) * 100 },
                    { key: 'hold', value: stats.hold, exact: (stats.hold / stats.total) * 100 },
                    { key: 'notStarted', value: stats.notStarted, exact: (stats.notStarted / stats.total) * 100 },
                    { key: 'carryOver', value: stats.carryOver, exact: (stats.carryOver / stats.total) * 100 },
                    { key: 'cancelled', value: stats.cancelled, exact: (stats.cancelled / stats.total) * 100 }
                ];

                // Floor all percentages and calculate remainders
                exactPercentages.forEach(item => {
                    percentages[item.key] = Math.floor(item.exact);
                    item.remainder = item.exact - Math.floor(item.exact);
                });

                // Calculate how many percentage points we need to distribute
                const currentSum = Object.values(percentages).reduce((a, b) => a + b, 0);
                let pointsToDistribute = 100 - currentSum;

                // Sort by remainder (descending) to distribute the remaining points
                exactPercentages.sort((a, b) => b.remainder - a.remainder);

                // Distribute remaining points to items with largest remainders
                for (let i = 0; i < pointsToDistribute; i++) {
                    percentages[exactPercentages[i].key]++;
                }
            }

            const statHTML = `
                <div class="stat-card" onclick="showStatusDetails('Total')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <span class="stat-value">${stats.total}</span>
                    <span class="stat-label">Total Initiatives</span>
                </div>
                <div class="stat-card done" onclick="showStatusDetails('Done')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(0,255,157,0.9); font-weight: 600;">${percentages.done}%</div>
                    <span class="stat-value">${stats.done}</span>
                    <span class="stat-label">Done</span>
                </div>
                <div class="stat-card ongoing" onclick="showStatusDetails('On Going')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(0,136,255,0.9); font-weight: 600;">${percentages.onGoing}%</div>
                    <span class="stat-value">${stats.onGoing}</span>
                    <span class="stat-label">On Going</span>
                </div>
                <div class="stat-card hold" onclick="showStatusDetails('Hold')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(255,136,0,0.9); font-weight: 600;">${percentages.hold}%</div>
                    <span class="stat-value">${stats.hold}</span>
                    <span class="stat-label">Hold</span>
                </div>
                <div class="stat-card notstarted" onclick="showStatusDetails('Not Started')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(136,136,136,0.9); font-weight: 600;">${percentages.notStarted}%</div>
                    <span class="stat-value">${stats.notStarted}</span>
                    <span class="stat-label">Not Started</span>
                </div>
                <div class="stat-card carryover" onclick="showStatusDetails('Carry Over')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(255,191,0,0.9); font-weight: 600;">${percentages.carryOver}%</div>
                    <span class="stat-value">${stats.carryOver}</span>
                    <span class="stat-label">Carry Over</span>
                </div>
                 <div class="stat-card cancelled" onclick="showStatusDetails('Cancelled')" style="cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 11px; color: rgba(255,0,85,0.9); font-weight: 600;">${percentages.cancelled}%</div>
                    <span class="stat-value">${stats.cancelled}</span>
                    <span class="stat-label">Cancelled</span>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statHTML;

            const destroyChart = (id) => {
                const chart = Chart.getChart(id);
                if (chart) chart.destroy();
            }

            const currentOwners = getActiveOwners();

            // --- Call Advanced Analytics Charts ---
            renderWorkloadChart(initiatives, currentOwners);
            renderSCurveChart(initiatives);
            renderAgingChart(initiatives);
            renderVelocityChart(initiatives);
            // Ensure container visibility
            const rowAdvanced = document.getElementById('row-charts-advanced');
            if (rowAdvanced) {
                const anyVisible = ['card-workload', 'card-scurve', 'card-aging', 'card-velocity'].some(cid => {
                    const c = document.getElementById(cid);
                    return c && c.style.display !== 'none';
                });
                rowAdvanced.style.display = anyVisible ? 'grid' : 'none';
            }

            // --- 2. RISK CHART ---
            renderRiskChart(initiatives);

            // --- 3. OWNER SPEED ---
            renderSpeedChart(initiatives, currentOwners);

            // --- 4. OWNER DISTRIBUTION ---
            renderOwnerDistChart(initiatives, currentOwners);

            // --- 5. OVERALL PROGRESS ---
            renderProgressTrendChart(initiatives);

            // --- 6. PROGRESS ANALYSIS ---
            if (window.updateProgressAnalysis) window.updateProgressAnalysis();

            // --- 7. STATUS DISTRIBUTION ---
            renderStatusDistChart(initiatives);

            // --- 8. FINANCIAL CHART ---
            renderFinancialChart(initiatives, currentOwners);

            // --- 9. COMPLETION BARS ---
            // A. Initiatives - Use same percentage as Done card
            const compDone = stats.done;
            const compTotal = stats.total;
            const compPercent = percentages.done; // Use the same percentage as Done card
            if (document.getElementById('completionBarFill')) {
                document.getElementById('completionBarFill').style.width = compPercent + '%';
                document.getElementById('completionBarText').innerText = compPercent + '%';
                document.getElementById('completionCount').innerText = compDone;
                document.getElementById('completionTotal').innerText = compTotal;
            }

            // B. Key Activities
            let kaTotal = 0;
            let kaValue = 0; // Will be Done Count for Admin, or Total Progress for User

            initiatives.forEach(i => {
                if (i.subInitiatives) {
                    kaTotal += i.subInitiatives.length;
                    if (isAdmin) {
                        // Admin: Count Done items (Original Logic)
                        kaValue += i.subInitiatives.filter(s => s.status === 'Done' || s.progress == 100).length;
                    } else {
                        // User: Sum Progress (New Logic)
                        kaValue += i.subInitiatives.reduce((sum, s) => sum + (parseFloat(s.progress) || 0), 0);
                    }
                }
            });

            let kaPercent = 0;
            if (kaTotal > 0) {
                if (isAdmin) {
                    kaPercent = Math.round((kaValue / kaTotal) * 100);
                } else {
                    kaPercent = Math.round(kaValue / kaTotal);
                }
            }

            if (document.getElementById('keyActivityBarFill')) {
                document.getElementById('keyActivityBarFill').style.width = kaPercent + '%';
                document.getElementById('keyActivityBarText').innerText = kaPercent + '%';
                // For users, show "Avg Progress" text or similar? Or just the count? 
                // The UI shows X/Y. For Admin it's Done/Total. 
                // For User, showing "SumProgress/Total" is meaningless (e.g. 1500/3). 
                // Let's keep showing the count of activities (Total) but the BAR represents progress.
                // Or maybe show "Done" count in the text like before?
                // The user complained about the PERCENTAGE (0%).
                // I will update the Count text to be consistent with what the bar represents? 
                // Actually, X/Y usually means "Items Completed / Total Items".
                // If I change the bar to be pure progress, X/Y becoming "Done/Total" is confusing if bar is 50% but Done is 0/3.
                // But changing X in X/Y to "Average" is weird.
                // I'll keep X/Y as "Done / Total" count for consistency, but enable the BAR to show progress?
                // Wait, if the bar is 50% but text is 0/3, user might be okay.
                // Let's count "Done" for the text label anyway (for consistency), but use Average for the Percent/Bar.

                let displayCount = 0;
                initiatives.forEach(i => {
                    if (i.subInitiatives) {
                        displayCount += i.subInitiatives.filter(s => s.status === 'Done' || s.progress == 100).length;
                    }
                });

                document.getElementById('keyActivityCount').innerText = displayCount;
                document.getElementById('keyActivityTotal').innerText = kaTotal;
            }

            // C. Status Breakdown Counts
            function updateQuickStats() {
                const initiatives = JSON.parse(localStorage.getItem('initiatives') || '[]');
                const total = initiatives.length;

                // Helper to calculate percentage
                const getPct = (count) => {
                    if (total === 0) return '0%';
                    return Math.round((count / total) * 100) + '%';
                };

                const counts = {
                    done: initiatives.filter(i => i.status === 'Done').length,
                    onGoing: initiatives.filter(i => ['On Progress', 'On Going'].includes(i.status)).length,
                    hold: initiatives.filter(i => i.status === 'Hold').length,
                    notStarted: initiatives.filter(i => i.status === 'Not Started').length,
                    carryOver: initiatives.filter(i => i.status === 'Carry Over').length,
                    cancelled: initiatives.filter(i => i.status === 'Cancelled').length
                };

                // Update DOM with Safe Checks
                if (document.getElementById('stat-total')) {
                    document.getElementById('stat-total').innerText = total;
                    if (document.getElementById('stat-total-pct')) document.getElementById('stat-total-pct').innerText = '100%';
                }

                if (document.getElementById('stat-done')) {
                    document.getElementById('stat-done').innerText = counts.done;
                    if (document.getElementById('stat-done-pct')) document.getElementById('stat-done-pct').innerText = getPct(counts.done);
                }

                if (document.getElementById('stat-ongoing')) {
                    document.getElementById('stat-ongoing').innerText = counts.onGoing;
                    if (document.getElementById('stat-ongoing-pct')) document.getElementById('stat-ongoing-pct').innerText = getPct(counts.onGoing);
                }

                if (document.getElementById('stat-hold')) {
                    document.getElementById('stat-hold').innerText = counts.hold;
                    if (document.getElementById('stat-hold-pct')) document.getElementById('stat-hold-pct').innerText = getPct(counts.hold);
                }

                if (document.getElementById('stat-notstarted')) {
                    document.getElementById('stat-notstarted').innerText = counts.notStarted;
                    if (document.getElementById('stat-notstarted-pct')) document.getElementById('stat-notstarted-pct').innerText = getPct(counts.notStarted);
                }

                if (document.getElementById('stat-carryover')) {
                    document.getElementById('stat-carryover').innerText = counts.carryOver;
                    // Add pct if element exists
                }

                if (document.getElementById('stat-cancelled')) {
                    document.getElementById('stat-cancelled').innerText = counts.cancelled;
                    // Add pct if element exists
                }
            }

            // --- 10. OWNER TABLE ---
            renderOwnerTable(initiatives, currentOwners);

            // --- 11. SIDEBAR STATS ---
            renderSidebarStats(initiatives);

            // Call Key Risk Chart
            if (window.renderKeyRiskChart) renderKeyRiskChart(initiatives);

            // Call Key Progress Chart
            if (window.renderKeyProgressChart) renderKeyProgressChart(initiatives);

            // Call Key Activity Chart (Timeline Effectiveness for Admin, Duration for User)
            if (isAdmin && typeof renderKeyActivityTimelineChart === 'function') {
                renderKeyActivityTimelineChart(initiatives);
                // Update Title Dynamically
                const titleEl = document.querySelector('#card-key-effectiveness .chart-header span');
                if (titleEl) titleEl.innerText = 'Key Activity Effectiveness (Timeline)';
            } else if (window.renderKeyActivityDurationChart) {
                renderKeyActivityDurationChart(initiatives);
                // Ensure Title is Standard
                const titleEl = document.querySelector('#card-key-effectiveness .chart-header span');
                if (titleEl) titleEl.innerText = 'Key Act. Duration';
            }

            // --- 12. KEY ACTIVITY OWNER CHART (New) ---
            if (isAdmin && typeof renderKeyActivityTimelineByOwnerChart === 'function') {
                renderKeyActivityTimelineByOwnerChart(initiatives, currentOwners);
                // Ensure visible if admin
                const card = document.getElementById('card-key-owner');
                if (card) card.style.display = 'flex';
            } else {
                // Hide for non-admins
                const card = document.getElementById('card-key-owner');
                if (card) card.style.display = 'none';
            }

            // --- 13. PROJECT HEATMAP ---
            renderProjectHeatmap(initiatives);

            // --- 14. INTELLIGENCE UPDATE / INSIGHTS ---
            generateInsights(initiatives, currentOwners, stats);

        } // End updateDashboard

        // --- INTELLIGENCE UPDATE / INSIGHTS FUNCTION ---
        // Global variables for insight detail modals
        let insightData = {
            initiatives: [],
            completionRate: 0,
            doneCount: 0,
            totalCount: 0,
            highRiskInitiatives: [],
            topOwner: '',
            topOwnerDuration: 0
        };

        // Show Budget Details Modal
        function showBudgetDetails() {
            const modal = document.getElementById('statusDetailModal');
            const title = document.getElementById('statusModalTitle');
            const list = document.getElementById('statusModalContent');

            if (!modal || !title || !list) return;

            const totalAlloc = insightData.totalBudget || 0;
            const totalUsed = insightData.totalCost || 0;
            const absorptionRate = totalAlloc > 0 ? Math.round((totalUsed / totalAlloc) * 100) : 0;
            const absorptionColor = absorptionRate > 100 ? '#f87171' : absorptionRate > 80 ? '#4ade80' : '#fbbf24';

            title.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: rgba(96, 165, 250, 0.2); color: #60a5fa; padding: 5px 10px; border-radius: 6px; font-size: 14px;">Absorpsi: ${absorptionRate}%</span>
                    <span>Budget Analysis</span>
                </div>
            `;

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(96, 165, 250, 0.2);">
                        <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 5px;">Total Budget</div>
                        <div style="font-size: 20px; font-weight: 800; color: #60a5fa;">Rp ${totalAlloc.toLocaleString('id-ID')}</div>
                    </div>
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(74, 222, 128, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(74, 222, 128, 0.2);">
                         <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 5px;">Realisasi (Cost)</div>
                         <div style="font-size: 20px; font-weight: 800; color: #4ade80;">Rp ${totalUsed.toLocaleString('id-ID')}</div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="pie-chart" style="width: 16px;"></i> Top Budget Users
                </h4>
                <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
            `;

            // Sort initiatives by budget
            const sortedByBudget = [...insightData.initiatives].sort((a, b) => (b.budget || 0) - (a.budget || 0)).slice(0, 5);

            sortedByBudget.forEach(init => {
                const b = init.budget || 0;
                const c = init.cost || 0;
                const p = b > 0 ? Math.round((c / b) * 100) : 0;
                const barColor = p > 100 ? '#f87171' : '#4ade80';

                html += `
                    <div style="padding: 16px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: white; font-size: 14px;">${init.name}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${init.owner}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: var(--text-muted);">
                            <span>Budget: Rp ${b.toLocaleString('id-ID')}</span>
                            <span>Used: ${p}%</span>
                        </div>
                        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${Math.min(p, 100)}%; height: 100%; background: ${barColor};"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            list.innerHTML = html;
            modal.style.display = 'flex';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Generate Insights
        function generateInsights(initiatives, owners, stats) {
            const insightTextEl = document.getElementById('insightText');
            const insightCompletionEl = document.getElementById('insightCompletionRate');
            const insightRiskEl = document.getElementById('insightRiskCount');
            const insightBudgetEl = document.getElementById('insightBudgetEff');
            const insightTopEl = document.getElementById('insightTopPerformer');

            if (!insightTextEl) return;
            insightData.initiatives = initiatives;

            // 1. Completion Metrics
            const total = initiatives.length;
            const done = initiatives.filter(i => i.status === 'Done').length;
            const ongoing = initiatives.filter(i => i.status === 'On Going').length;
            const hold = initiatives.filter(i => i.status === 'Hold').length;
            const notStarted = initiatives.filter(i => i.status === 'Not Started').length;
            const completionRate = total > 0 ? Math.round((done / total) * 100) : 0;

            // 2. Risk Metrics
            // Logic: Due within 30 days and progress < 50% OR Overdue
            const now = new Date();
            const highRisk = initiatives.filter(i => {
                if (!i.dueDate || i.status === 'Done' || i.status === 'Cancelled') return false;
                const d = new Date(i.dueDate);
                const diffTime = d - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                // Overdue
                if (diffDays < 0) return true;
                // Approaching deadline with low progress
                if (diffDays <= 30 && i.progress < 50) return true;
                return false;
            });
            const riskCount = highRisk.length;

            // --- POPULATE INSIGHT DATA FOR DETAIL MODALS ---
            insightData.initiatives = initiatives;
            insightData.completionRate = completionRate;
            insightData.doneCount = done;
            insightData.totalCount = total;

            // Populate high risk initiatives with detailed info
            insightData.highRiskInitiatives = highRisk.map(i => {
                const dueDate = new Date(i.dueDate);
                const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                return {
                    id: i.id,
                    name: i.name,
                    owner: i.owner,
                    dueDate: i.dueDate,
                    progress: i.progress,
                    status: i.status,
                    daysLeft: daysLeft,
                    isStrategic: i.urgency === 'High' || i.urgency === 'Critical'
                };
            });
            insightData.strategicRiskCount = insightData.highRiskInitiatives.filter(r => r.isStrategic).length;

            // 3. Budget Metrics
            let totalBudget = 0;
            let totalCost = 0;

            // 4. Owner Performance (Top 5)
            const ownerStats = {};

            initiatives.forEach(i => {
                // Financials
                const b = parseFloat(i.budget) || 0;
                // Use cost if exists, else estimate based on progress
                let c = parseFloat(i.cost) || 0;
                if (!i.cost && i.cost !== 0) {
                    if (i.status === 'Done') c = b;
                    else c = b * ((i.progress || 0) / 100);
                }
                totalBudget += b;
                totalCost += c;

                // Owner Stats
                const owner = i.owner || 'Unknown';
                if (!ownerStats[owner]) ownerStats[owner] = { total: 0, done: 0, score: 0 };
                ownerStats[owner].total++;
                if (i.status === 'Done') ownerStats[owner].done++;
            });

            const absorption = totalBudget > 0 ? Math.round((totalCost / totalBudget) * 100) : 0;
            insightData.totalBudget = totalBudget;
            insightData.totalCost = totalCost;

            // Calculate Owner Scores (% Done)
            Object.keys(ownerStats).forEach(key => {
                const s = ownerStats[key];
                // Simple Score: % of projects Done
                s.score = s.total > 0 ? (s.done / s.total) * 100 : 0;
            });

            // Sort Top 5
            const sortedOwners = Object.entries(ownerStats)
                .sort(([, a], [, b]) => b.score - a.score) // Descending
                .slice(0, 5);

            const topOwnerName = sortedOwners.length > 0 ? sortedOwners[0][0].replace('Divisi ', '').replace('Sub Divisi ', '') : '-';

            // --- UPDATE UI STATS ---
            if (insightCompletionEl) insightCompletionEl.innerText = completionRate + '%';
            if (insightRiskEl) {
                insightRiskEl.innerText = riskCount;
                if (riskCount > 0) insightRiskEl.classList.add('warning');
            }
            if (insightBudgetEl) insightBudgetEl.innerText = absorption + '%';
            if (insightTopEl) insightTopEl.innerText = topOwnerName;


            // --- HOVER DETAILS ---
            // Completion Hover
            const hoverComp = document.getElementById('hoverCompletion');
            if (hoverComp) {
                hoverComp.innerHTML = `
                    <div style="font-size:12px; font-weight:700; color:white; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">STATUS BREAKDOWN</div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#4ade80;">Done</span> <span>${done}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#3b82f6;">On Going</span> <span>${ongoing}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#fbbf24;">Hold</span> <span>${hold}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#94a3b8;">Not Started</span> <span>${notStarted}</span></div>
                `;
            }

            // Risk Hover
            const hoverRisk = document.getElementById('hoverRisk');
            if (hoverRisk) {
                let riskHtml = `<div style="font-size:12px; font-weight:700; color:white; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">TOP RISKS</div>`;
                const topRisks = highRisk.slice(0, 5);
                if (topRisks.length === 0) riskHtml += `<div style="font-size:11px; color:#94a3b8; font-style:italic;">No immediate risks detected.</div>`;
                else {
                    topRisks.forEach(r => {
                        riskHtml += `<div style="font-size:10px; color:#f87171; mb-1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">• ${r.name}</div>`;
                    });
                }
                if (highRisk.length > 5) riskHtml += `<div style="font-size:10px; color:#94a3b8; margin-top:3px;">+${highRisk.length - 5} lainnya</div>`;
                hoverRisk.innerHTML = riskHtml;
            }

            // Budget Hover
            const hoverBudget = document.getElementById('hoverBudget');
            if (hoverBudget) {
                const bM = (totalBudget / 1000000000).toFixed(1) + 'M'; // Assuming Billions usually
                const cM = (totalCost / 1000000000).toFixed(1) + 'M';
                hoverBudget.innerHTML = `
                    <div style="font-size:12px; font-weight:700; color:white; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">FINANCIALS</div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#94a3b8;">Budget</span> <span>Rp ${bM}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#94a3b8;">Realisasi</span> <span>Rp ${cM}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px;"><span style="color:#a78bfa;">Absorpsi</span> <span>${absorption}%</span></div>
                `;
            }

            // Top Performer Hover
            const hoverTop = document.getElementById('hoverTopPerformer');
            if (hoverTop) {
                let topHtml = `<div style="font-size:12px; font-weight:700; color:white; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">TOP 5 PERFORMERS</div>`;
                if (sortedOwners.length === 0) topHtml += `<div style="font-size:11px; color:#94a3b8;">No data available.</div>`;
                else {
                    sortedOwners.forEach(([name, s], idx) => {
                        const clean = name.replace('Divisi ', '').replace('Sub Divisi ', '').substring(0, 20);
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '•';
                        topHtml += `
                            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px; align-items:center;">
                                <span style="color:${idx === 0 ? '#fbbf24' : '#e2e8f0'}">${medal} ${clean}</span>
                                <span style="font-weight:bold; color:#4ade80;">${Math.round(s.score)}%</span>
                            </div>
                        `;
                    });
                }
                hoverTop.innerHTML = topHtml;
            }


            // 5. COMPREHENSIVE INDONESIAN NARRATIVE GENERATION
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonth = monthNames[now.getMonth()];

            // Calculate additional metrics for comprehensive narrative
            const totalBudgetM = (totalBudget / 1000000000).toFixed(1);
            const totalCostM = (totalCost / 1000000000).toFixed(1);

            // Top Performer detailed stats
            let topPerformerStats = { doneCount: 0, avgDays: 45, costPerInit: 0 };
            if (sortedOwners.length > 0) {
                const topOwner = sortedOwners[0][0];
                const topOwnerInits = initiatives.filter(i => i.owner === topOwner);
                const doneInits = topOwnerInits.filter(i => i.status === 'Done');
                topPerformerStats.doneCount = doneInits.length;

                // Calculate average days (from start to completion)
                let totalDays = 0;
                doneInits.forEach(init => {
                    if (init.startDate && init.dueDate) {
                        const start = new Date(init.startDate);
                        const end = new Date(init.dueDate);
                        totalDays += Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    }
                });
                topPerformerStats.avgDays = doneInits.length > 0 ? Math.round(totalDays / doneInits.length) : 45;
                if (topPerformerStats.avgDays === 0) topPerformerStats.avgDays = 45;

                // Cost per initiative
                const topOwnerBudget = topOwnerInits.reduce((sum, i) => sum + (parseInt(i.budget) || 0), 0);
                topPerformerStats.costPerInit = topOwnerInits.length > 0 ? (topOwnerBudget / topOwnerInits.length / 1000000000).toFixed(1) : 0;
            }

            // High risk budget exposure
            const highRiskBudget = highRisk.reduce((sum, i) => sum + (parseInt(i.budget) || 0), 0);
            const highRiskBudgetM = (highRiskBudget / 1000000000).toFixed(1);

            // Overdue key activities count
            let overdueKACount = 0;
            let strategicOverdueCount = 0;
            let overdueKABudget = 0;
            initiatives.forEach(init => {
                if (init.subInitiatives) {
                    init.subInitiatives.forEach(sub => {
                        if (sub.dueDate && new Date(sub.dueDate) < now && sub.status !== 'Done') {
                            overdueKACount++;
                            if (init.urgency === 'High' || init.urgency === 'Critical') {
                                strategicOverdueCount++;
                                overdueKABudget += (parseInt(init.budget) || 0) / (init.subInitiatives.length || 1);
                            }
                        }
                    });
                }
            });
            const overdueKABudgetM = (overdueKABudget / 1000000000).toFixed(1);

            // Build comprehensive Indonesian narrative with highlighted keywords
            let narrative = `Progress saat ini <span class="highlight-green">${completionRate}%</span>, `;
            narrative += completionRate < 50 ? `masih di bawah kurva ideal. ` : `mendekati target kurva ideal. `;

            narrative += `Dari total anggaran sebesar <span class="highlight-blue">Rp${totalBudgetM}M</span>, realisasi mencapai <span class="highlight-blue">Rp${totalCostM}M</span> (<span class="highlight-green">${absorption}%</span>), `;
            narrative += absorption > completionRate ? `mengindikasikan <span class="highlight-yellow">gap serapan biaya</span> terhadap output. ` : `menunjukkan efisiensi penyerapan anggaran. `;

            if (sortedOwners.length > 0) {
                narrative += `<span class="highlight-green">${topOwnerName}</span> menjadi top performer `;
                narrative += `(${topPerformerStats.doneCount} inisiatif selesai, avg. ${topPerformerStats.avgDays} hari). `;
            }

            if (riskCount > 0) {
                narrative += `Namun terdapat <span class="highlight-yellow">${riskCount} inisiatif berisiko tinggi</span> senilai Rp${highRiskBudgetM}M `;
                narrative += `yang berpotensi mengalami cost overrun. `;
            }

            if (overdueKACount > 0) {
                narrative += `<span class="highlight-red">${overdueKACount} key activities overdue</span>`;
                if (strategicOverdueCount > 0) {
                    narrative += `, ${strategicOverdueCount} strategis dengan eksposur Rp${overdueKABudgetM}M. `;
                } else {
                    narrative += `. `;
                }
            }

            narrative += `Fokus 30 hari: mitigasi risiko, pengendalian burn rate, dan percepatan prioritas.`;

            insightTextEl.innerHTML = `"${narrative}"`;

            // Update Time
            const timeEl = document.getElementById('insightTime');
            if (timeEl) timeEl.innerText = "NOW";

            // Populate data for Voice Note (read from DOM later)
        }


        // Toggle Voice Note Player - BLUE DESIGN
        window.toggleVoiceNote = function (el) {
            const btn = el.querySelector('.voice-play-btn');
            if (!btn) return;

            const isPlaying = btn.getAttribute('data-state') === 'playing';
            const iconColor = '#0088ff'; // Blue color for design

            // Reset all players
            document.querySelectorAll('.voice-play-btn').forEach(b => {
                b.innerHTML = `<i data-lucide="play" style="width: 16px; height: 16px; color: ${iconColor}; fill: ${iconColor};"></i>`;
                b.setAttribute('data-state', 'paused');
            });

            // Toggle current
            if (!isPlaying) {
                btn.innerHTML = `<i data-lucide="pause" style="width: 16px; height: 16px; color: ${iconColor}; fill: ${iconColor};"></i>`;
                btn.setAttribute('data-state', 'playing');

                // Start speech synthesis with Indonesian voice
                const insightText = document.getElementById('insightText');
                if (insightText && window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                    const text = insightText.innerText.replace(/"/g, '');
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'id-ID';
                    utterance.rate = 1.0;

                    // Try to find Indonesian voice
                    const voices = window.speechSynthesis.getVoices();
                    const idVoice = voices.find(v => v.lang.startsWith('id'));
                    if (idVoice) utterance.voice = idVoice;

                    utterance.onend = () => {
                        btn.innerHTML = `<i data-lucide="play" style="width: 16px; height: 16px; color: ${iconColor}; fill: ${iconColor};"></i>`;
                        btn.setAttribute('data-state', 'paused');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    };

                    window.speechSynthesis.speak(utterance);
                }
            } else {
                btn.innerHTML = `<i data-lucide="play" style="width: 16px; height: 16px; color: ${iconColor}; fill: ${iconColor};"></i>`;
                btn.setAttribute('data-state', 'paused');
                window.speechSynthesis?.cancel();
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Show Full Analysis - Navigate to Analytics page
        window.showFullAnalysis = function () {
            window.location.href = 'analytics.html';
        };

        // Show Completion Rate Details Modal
        function showCompletionDetails() {
            const modal = document.getElementById('statusDetailModal');
            const title = document.getElementById('statusModalTitle');
            const list = document.getElementById('statusModalContent');

            if (!modal || !title || !list) return;

            title.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;" >
                    <span style="background: rgba(74, 222, 128, 0.2); color: #4ade80; padding: 5px 10px; border-radius: 6px; font-size: 14px;">Rate: ${insightData.completionRate}%</span>
                    <span>Completion Details</span>
                </div>
            `;

            let html = `
            <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(74, 222, 128, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(74, 222, 128, 0.2); display: flex; align-items: center; justify-content: space-between;" >
                    <div>
                        <div style="font-size: 32px; font-weight: 800; color: #4ade80; line-height: 1;">${insightData.doneCount} <span style="font-size: 16px; color: var(--text-muted); font-weight: normal;">of ${insightData.totalCount}</span></div>
                        <div style="color: var(--text-muted); font-size: 14px; margin-top: 5px;">Initiatives Completed</div>
                    </div>
                    <div style="background: rgba(74, 222, 128, 0.2); padding: 10px; border-radius: 50%;">
                        <i data-lucide="check-circle" style="color: #4ade80; width: 24px; height: 24px;"></i>
                    </div>
                </div>

            <h4 style="margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="list" style="width: 16px;"></i> Completed Initiatives
            </h4>
        `;

            const doneInitiatives = insightData.initiatives.filter(i => i.status === 'Done');
            if (doneInitiatives.length > 0) {
                html += '<div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">';
                doneInitiatives.forEach(init => {
                    const ownerName = init.owner?.replace('Sub Divisi ', '').replace('Divisi ', '') || 'N/A';
                    html += `
            <div style="padding: 16px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: transform 0.2s; cursor: default;" >
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                    <div>
                        <div style="font-weight: 600; color: white; font-size: 15px; margin-bottom: 4px;">${init.name}</div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <i data-lucide="user" style="width: 12px; color: var(--text-muted);"></i>
                            <span style="font-size: 13px; color: var(--text-muted);">${ownerName}</span>
                        </div>
                    </div>
                    <span style="background: rgba(74, 222, 128, 0.15); color: #4ade80; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; white-space: nowrap;">Done</span>
                </div>
                        </div>
            `;
                });
                html += '</div>';
            } else {
                html += `
            <div style="padding: 40px; text-align: center; color: var(--text-muted); background: rgba(255,255,255,0.02); border-radius: 12px;" >
                        <i data-lucide="inbox" style="margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Belum ada initiative yang selesai.</p>
                    </div> `;
            }

            list.innerHTML = html;
            modal.style.display = 'flex';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Show Risk Details Modal
        function showRiskDetails() {
            const modal = document.getElementById('statusDetailModal');
            const title = document.getElementById('statusModalTitle');
            const list = document.getElementById('statusModalContent');

            if (!modal || !title || !list) return;

            title.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;" >
                    <span style="background: rgba(248, 113, 113, 0.2); color: #f87171; padding: 5px 10px; border-radius: 6px; font-size: 14px;">${insightData.highRiskInitiatives.length} Risks</span>
                    <span>High Risk Analysis</span>
                </div>
            `;

            let html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;" >
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(248, 113, 113, 0.1) 0%, rgba(248, 113, 113, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(248, 113, 113, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-size: 28px; font-weight: 800; color: #f87171;">${insightData.highRiskInitiatives.length}</div>
                                <div style="color: var(--text-muted); font-size: 12px;">Total High Risk</div>
                            </div>
                            <i data-lucide="alert-triangle" style="color: #f87171; width: 20px;"></i>
                        </div>
                    </div>
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(251, 146, 60, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(251, 146, 60, 0.2);">
                         <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-size: 28px; font-weight: 800; color: #fb923c;">${insightData.strategicRiskCount || 0}</div>
                                <div style="color: var(--text-muted); font-size: 12px;">Strategic Impact</div>
                            </div>
                            <i data-lucide="zap" style="color: #fb923c; width: 20px;"></i>
                        </div>
                    </div>
                </div>

            <h4 style="margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="activity" style="width: 16px;"></i> Critical Items Focus
            </h4>
        `;

            if (insightData.highRiskInitiatives.length > 0) {
                html += '<div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">';
                insightData.highRiskInitiatives.forEach(init => {
                    const urgencyColor = init.daysLeft < 0 ? '#ef4444' : init.daysLeft <= 3 ? '#fbbf24' : '#fb923c';
                    const urgencyBg = init.daysLeft < 0 ? 'rgba(239, 68, 68, 0.2)' : init.daysLeft <= 3 ? 'rgba(251, 191, 36, 0.2)' : 'rgba(251, 146, 60, 0.2)';
                    const urgencyText = init.daysLeft < 0 ? `${Math.abs(init.daysLeft)} days overdue` : init.daysLeft === 0 ? 'Due Today' : `${init.daysLeft} days left`;
                    const ownerName = init.owner?.replace('Sub Divisi ', '').replace('Divisi ', '') || 'N/A';

                    html += `
            <div style="padding: 16px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: transform 0.2s;" >
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <div style="font-weight: 600; color: white; font-size: 15px;">${init.name}</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <i data-lucide="user" style="width: 12px; color: var(--text-muted);"></i>
                                            <span style="font-size: 13px; color: var(--text-muted);">${ownerName}</span>
                                        </div>
                                        ${init.isStrategic ? '<span style="background: rgba(168, 85, 247, 0.2); color: #c084fc; padding: 2px 8px; border-radius: 4px; font-size: 10px; border: 1px solid rgba(168, 85, 247, 0.3);">STRATEGIC</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                                <div style="font-size: 12px; color: var(--text-muted);">Due: ${init.dueDate}</div>
                                <span style="background: ${urgencyBg}; color: ${urgencyColor}; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="clock" style="width: 10px;"></i>
                                    ${urgencyText}
                                </span>
                            </div>
                        </div>
            `;
                });
                html += '</div>';
            } else {
                html += `
            <div style="padding: 40px; text-align: center; color: #4ade80; background: rgba(74, 222, 128, 0.05); border-radius: 12px; border: 1px dashed rgba(74, 222, 128, 0.3);" >
                        <i data-lucide="shield-check" style="margin-bottom: 10px; width: 32px; height: 32px;"></i>
                        <p style="font-weight: 600;">Semua aman! Tidak ada initiative berisiko tinggi saat ini.</p>
                    </div> `;
            }

            list.innerHTML = html;
            modal.style.display = 'flex';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }


        function renderProjectHeatmap(initiatives) {
            const container = document.getElementById('heatmapBubblesContainer');
            if (!container) return;

            container.innerHTML = ''; // Clear existing bubbles

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let normalCount = 0;
            let warningCount = 0;
            let criticalCount = 0;

            // Calculate bubble data
            const bubbleData = initiatives.map((init, index) => {
                const progress = parseInt(init.progress) || 0;
                const dueDate = init.dueDate ? new Date(init.dueDate) : null;
                const status = init.status || '';

                let category = 'normal'; // Default

                if (status === 'Done') {
                    category = 'normal';
                } else if (status === 'Cancelled') {
                    category = 'normal'; // Grey could be added, but using normal for now
                } else if (status === 'Not Started') {
                    // Not started - check if due date is near
                    if (dueDate) {
                        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        if (daysUntilDue < 0) {
                            category = 'critical';
                        } else if (daysUntilDue <= 14) {
                            category = 'warning';
                        }
                    }
                } else {
                    // On Going, Hold, Carry Over
                    if (dueDate) {
                        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        if (daysUntilDue < 0) {
                            category = 'critical';
                        } else if (daysUntilDue <= 14) {
                            category = 'warning';
                        } else {
                            category = 'normal';
                        }
                    }
                }

                // Count categories
                if (category === 'normal') normalCount++;
                else if (category === 'warning') warningCount++;
                else if (category === 'critical') criticalCount++;

                return {
                    id: init.id,
                    name: init.name,
                    progress: progress,
                    dueDate: init.dueDate,
                    status: status,
                    category: category,
                    index: index
                };
            });

            // Size range for bubbles (in pixels)
            const minSize = 60;
            const maxSize = 100;

            bubbleData.forEach((data, i) => {
                // Size based on progress (higher progress = larger bubble)
                const size = minSize + ((data.progress / 100) * (maxSize - minSize));

                // Animation delay for staggered effect
                const delay = (i * 0.1) % 2;

                const bubble = document.createElement('div');
                bubble.className = `heatmap-bubble ${data.category}`;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.setProperty('--delay', `${delay}s`);

                // Inner circle with progress number
                const inner = document.createElement('div');
                inner.className = 'bubble-inner';
                inner.textContent = data.progress + '%';

                // Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'heatmap-tooltip';
                const dueDateStr = data.dueDate ? new Date(data.dueDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : 'No due date';
                tooltip.innerHTML = `<strong>${data.name}</strong><br>Due: ${dueDateStr}<br>Status: ${data.status}`;

                // Click handler to show details
                bubble.onclick = function () {
                    showHeatmapInitiativeDetail(data.id);
                };

                bubble.appendChild(inner);
                bubble.appendChild(tooltip);
                container.appendChild(bubble);
            });

            // Update legend counts
            const totalEl = document.getElementById('heatmapTotalUnits');
            const normalEl = document.getElementById('heatmapNormalCount');
            const warningEl = document.getElementById('heatmapWarningCount');
            const criticalEl = document.getElementById('heatmapCriticalCount');

            if (totalEl) totalEl.textContent = initiatives.length;
            if (normalEl) normalEl.textContent = normalCount;
            if (warningEl) warningEl.textContent = warningCount;
            if (criticalEl) criticalEl.textContent = criticalCount;

            // --- SOUND ALERT FOR CRITICAL PROJECTS ---
            updateCriticalAlertState(criticalCount);

            // Re-init Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- HEATMAP SOUND ALERT SYSTEM ---
        window.heatmapSoundEnabled = localStorage.getItem('heatmapSoundEnabled') !== 'false';
        let heatmapAlertInterval = null;
        let heatmapCriticalActive = false;
        let audioContext = null;

        // Initialize sound state on load
        function initHeatmapSound() {
            const iconEl = document.getElementById('heatmapSoundIcon');
            const labelEl = document.getElementById('heatmapSoundLabel');
            const btn = document.getElementById('heatmapSoundToggle');

            if (window.heatmapSoundEnabled) {
                if (iconEl) iconEl.setAttribute('data-lucide', 'volume-2');
                if (labelEl) labelEl.textContent = 'SOUND ON';
                if (btn) btn.style.borderColor = 'rgba(251, 191, 36, 0.5)';
            } else {
                if (iconEl) iconEl.setAttribute('data-lucide', 'volume-x');
                if (labelEl) labelEl.textContent = 'MUTED';
                if (btn) btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Toggle sound on/off
        window.toggleHeatmapSound = function () {
            window.heatmapSoundEnabled = !window.heatmapSoundEnabled;
            localStorage.setItem('heatmapSoundEnabled', window.heatmapSoundEnabled);

            const iconEl = document.getElementById('heatmapSoundIcon');
            const labelEl = document.getElementById('heatmapSoundLabel');
            const btn = document.getElementById('heatmapSoundToggle');

            if (window.heatmapSoundEnabled) {
                if (iconEl) iconEl.setAttribute('data-lucide', 'volume-2');
                if (labelEl) labelEl.textContent = 'SOUND ON';
                if (btn) {
                    btn.style.borderColor = 'rgba(251, 191, 36, 0.5)';
                    btn.style.background = 'rgba(251, 191, 36, 0.1)';
                }
                // Resume alert if critical is still active
                if (heatmapCriticalActive) {
                    startCriticalAlertLoop();
                }
            } else {
                if (iconEl) iconEl.setAttribute('data-lucide', 'volume-x');
                if (labelEl) labelEl.textContent = 'MUTED';
                if (btn) {
                    btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    btn.style.background = 'rgba(255, 255, 255, 0.1)';
                }
                // Stop the alert loop
                stopCriticalAlertLoop();
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Start continuous alert loop
        function startCriticalAlertLoop() {
            // Don't start if already running or sound is disabled
            if (heatmapAlertInterval || !window.heatmapSoundEnabled) return;

            // Play immediately first
            playAlertBeep();

            // Then play every 5 seconds
            heatmapAlertInterval = setInterval(() => {
                if (window.heatmapSoundEnabled && heatmapCriticalActive) {
                    playAlertBeep();
                    flashCriticalIndicator();
                } else {
                    stopCriticalAlertLoop();
                }
            }, 5000); // Every 5 seconds
        }

        // Stop the alert loop
        function stopCriticalAlertLoop() {
            if (heatmapAlertInterval) {
                clearInterval(heatmapAlertInterval);
                heatmapAlertInterval = null;
            }
        }

        // Play a single alert beep
        function playAlertBeep() {
            try {
                // Create or resume AudioContext
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Resume if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create oscillator for alert tone
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Alert sound pattern - warning beeps
                const now = audioContext.currentTime;

                // Two-tone alert (like an alarm)
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.frequency.setValueAtTime(600, now + 0.15);
                oscillator.frequency.setValueAtTime(800, now + 0.30);
                oscillator.frequency.setValueAtTime(600, now + 0.45);

                // Volume envelope
                gainNode.gain.setValueAtTime(0.4, now);
                gainNode.gain.setValueAtTime(0.4, now + 0.5);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.6);

                oscillator.type = 'square'; // More alarm-like sound
                oscillator.start(now);
                oscillator.stop(now + 0.6);

            } catch (e) {
                console.log('Audio playback error:', e);
            }
        }

        // Flash the critical count indicator
        function flashCriticalIndicator() {
            const criticalEl = document.getElementById('heatmapCriticalCount');
            if (criticalEl && criticalEl.parentElement) {
                criticalEl.parentElement.style.animation = 'none';
                criticalEl.parentElement.offsetHeight; // Trigger reflow
                criticalEl.parentElement.style.animation = 'critical-flash 1s ease 2';
            }
        }

        // Called when critical count changes
        function updateCriticalAlertState(criticalCount) {
            const wasCritical = heatmapCriticalActive;
            heatmapCriticalActive = criticalCount > 0;

            if (heatmapCriticalActive && !wasCritical) {
                // Critical projects appeared - start alert
                if (window.heatmapSoundEnabled) {
                    startCriticalAlertLoop();
                }
            } else if (!heatmapCriticalActive && wasCritical) {
                // No more critical projects - stop alert
                stopCriticalAlertLoop();
            }
        }

        // Initialize sound state when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(initHeatmapSound, 500);
        });

        // Enable audio on first user interaction (browser policy workaround)
        document.addEventListener('click', function initAudioOnClick() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            // Remove listener after first interaction
            document.removeEventListener('click', initAudioOnClick);
        }, { once: true });

        // --- HEATMAP INITIATIVE DETAIL MODAL ---
        function showHeatmapInitiativeDetail(initiativeId) {
            const initiative = initiatives.find(i => i.id === initiativeId);
            if (!initiative) return;

            const modal = document.getElementById('heatmapInitiativeModal');
            const content = document.getElementById('heatmapModalContent');
            if (!modal || !content) return;

            // Status color mapping
            const statusColors = {
                'Done': '#00ff9d',
                'On Going': '#0088ff',
                'Hold': '#ff8800',
                'Not Started': '#888888',
                'Carry Over': '#ffbf00',
                'Cancelled': '#ff0055'
            };
            const statusColor = statusColors[initiative.status] || '#888';

            // Format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            // Build Key Activities HTML
            let keyActivitiesHTML = '';
            if (initiative.subInitiatives && initiative.subInitiatives.length > 0) {
                keyActivitiesHTML = `
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="list-checks" style="width: 16px; height: 16px;"></i>
                            Key Activities (${initiative.subInitiatives.length})
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${initiative.subInitiatives.map((sub, idx) => {
                    const subProgress = parseInt(sub.progress) || 0;
                    const subStatusColor = sub.status === 'Done' ? '#00ff9d' : (subProgress >= 50 ? '#0088ff' : '#ff8800');
                    return `
                                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: white; font-size: 13px; font-weight: 500;">${idx + 1}. ${sub.name || 'Unnamed Activity'}</span>
                                            <span style="color: ${subStatusColor}; font-size: 12px; font-weight: 600;">${subProgress}%</span>
                                        </div>
                                        <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                                            <div style="height: 100%; width: ${subProgress}%; background: ${subStatusColor}; border-radius: 2px; transition: width 0.3s;"></div>
                                        </div>
                                        <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                                            <span>Due: ${formatDate(sub.dueDate)}</span>
                                            <span>Status: ${sub.status || '-'}</span>
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            } else {
                keyActivitiesHTML = `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center;">
                        <span style="color: var(--text-muted); font-size: 13px;">No Key Activities</span>
                    </div>
                `;
            }

            // Main content HTML
            content.innerHTML = `
            <!-- Initiative Name & Status -->
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-size: 20px; margin: 0 0 10px 0; line-height: 1.4;">${initiative.name}</h2>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span style="background: ${statusColor}22; color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${initiative.status}</span>
                    ${initiative.entity ? `<span style="background: rgba(255,255,255,0.1); color: var(--text-muted); padding: 4px 12px; border-radius: 20px; font-size: 12px;">${typeof ENTITIES !== 'undefined' && ENTITIES[initiative.entity] ? ENTITIES[initiative.entity] : initiative.entity}</span>` : ''}
                </div>
            </div>

            <!-- Progress Bar -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted); font-size: 13px;">Overall Progress</span>
                    <span style="color: white; font-weight: 700; font-size: 16px;">${initiative.progress || 0}%</span>
                </div>
                <div style="height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
                    <div style="height: 100%; width: ${initiative.progress || 0}%; background: linear-gradient(90deg, ${statusColor}, ${statusColor}aa); border-radius: 5px; transition: width 0.5s;"></div>
                </div>
            </div>

            <!-- Details Grid -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Owner</div>
                    <div style="color: white; font-size: 14px; font-weight: 500;">${initiative.owner || '-'}</div>
                </div>
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Due Date</div>
                    <div style="color: white; font-size: 14px; font-weight: 500;">${formatDate(initiative.dueDate)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Start Date</div>
                    <div style="color: white; font-size: 14px; font-weight: 500;">${formatDate(initiative.startDate)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);">
                    <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Budget</div>
                    <div style="color: white; font-size: 14px; font-weight: 500;">${initiative.budget ? 'Rp ' + parseInt(initiative.budget).toLocaleString('id-ID') : '-'}</div>
                </div>
            </div>

            ${keyActivitiesHTML}

            <!-- Action Button -->
            <div style="margin-top: 25px; text-align: center;">
                <button onclick="window.location.href='projects.html?id=${initiative.id}'"
                    style="background: linear-gradient(135deg, var(--primary), #0088ff); color: black; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    <i data-lucide="external-link" style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 8px;"></i>
                    View Full Details
                </button>
            </div>
            `;

            // Show modal
            modal.style.display = 'flex';

            // Re-init Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeHeatmapModal() {
            const modal = document.getElementById('heatmapInitiativeModal');
            if (modal) modal.style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('heatmapInitiativeModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeHeatmapModal();
            }
        });

        // --- STATUS FILTER FUNCTION ---
        function filterByStatus(status) {
            // Navigate to projects page with status filter
            if (status === 'Total') {
                window.location.href = 'projects.html';
            } else {
                window.location.href = `projects.html?status=${encodeURIComponent(status)}`;
            }
        }


        // --- INITIATIVES PROGRESS ANALYSIS (Interactive) ---
        let progressChartInstance = null;

        window.renderProgressAnalysisChart = function (statusFilter) {
            const canvas = document.getElementById('initiativeProgressChart');
            if (!canvas) return;
            if (progressChartInstance) progressChartInstance.destroy();

            // Get Current Owners dynamically
            const currentOwners = getActiveOwners();
            const ownerShortNames = currentOwners.map(o => o.replace("Sub Divisi ", "").replace("Divisi ", "").substring(0, 15));

            const dataCounts = currentOwners.map(owner => {
                return initiatives.filter(i => i.owner === owner && i.status === statusFilter).length;
            });

            progressChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ownerShortNames,
                    datasets: [{
                        label: `${statusFilter} Initiatives`,
                        data: dataCounts,
                        backgroundColor: (context) => {
                            const { ctx, chartArea } = context.chart;
                            if (!chartArea) return null;
                            let c1 = '#00f2ff', c2 = '#050c38'; // Default Done (Cyan)
                            if (statusFilter === 'On Going') { c1 = '#0066ff'; c2 = '#050c38'; }
                            else if (statusFilter === 'Hold') { c1 = '#fbbf24'; c2 = '#31006a'; }
                            else if (statusFilter === 'Not Started') { c1 = '#475569'; c2 = '#000000'; }
                            else if (statusFilter === 'Carry Over') { c1 = '#fbbf24'; c2 = '#31006a'; }
                            else if (statusFilter === 'Cancelled') { c1 = '#64748b'; c2 = '#000000'; }
                            return createChartGradient(ctx, c1, c2, false, chartArea);
                        },
                        borderRadius: 4,
                        barThickness: 25
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: 'white',
                            formatter: (val) => val > 0 ? val : ''
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: '#a0a0b0' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 }, color: 'white' }
                        }
                    }
                }
            });
        }

        window.updateProgressAnalysis = function () {
            const status = document.getElementById('progressAnalysisFilter') ? document.getElementById('progressAnalysisFilter').value : 'Done';
            renderProgressAnalysisChart(status);
        };

        // Initial Call
        updateDashboard();

        window.renderKeyProgressChart = function (initiatives) {
            const canvas = document.getElementById('keyProgressChart');
            if (!canvas) return;

            // Destroy old
            const existing = Chart.getChart(canvas);
            if (existing) existing.destroy();

            // Calculate
            let totalKeys = 0;
            let doneKeys = 0;
            initiatives.forEach(i => {
                if (i.subInitiatives) {
                    totalKeys += i.subInitiatives.length;
                    // Count if status is Done OR progress is 100
                    doneKeys += i.subInitiatives.filter(s => s.status === 'Done' || s.progress == 100).length;
                }
            });

            const percent = totalKeys > 0 ? Math.round((doneKeys / totalKeys) * 100) : 0;
            const remaining = 100 - percent;

            const ctx = canvas.getContext('2d');
            // Doughnut Chart
            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Done', 'Remaining'],
                    datasets: [{
                        data: [percent, remaining],
                        backgroundColor: (context) => {
                            const { ctx, chartArea } = context.chart;
                            if (!chartArea) return null;
                            if (context.dataIndex === 0) {
                                return createCircularGradient(ctx, '#00f2ff', '#050c38', chartArea);
                            }
                            return 'rgba(255,255,255,0.05)';
                        },
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: { display: false } // No labels on ring
                    }
                },
                plugins: [{
                    id: 'centerText',
                    beforeDraw: function (chart) {
                        const width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        const fontSize = (height / 114).toFixed(2);
                        ctx.font = "bold " + fontSize + "em sans-serif";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "white";
                        const text = percent + "%",
                            textX = Math.round((width - ctx.measureText(text).width) / 2),
                            textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        function showTopPerformerDetails() {
            const modal = document.getElementById('statusDetailModal');
            const title = document.getElementById('statusModalTitle');
            const list = document.getElementById('statusModalContent');

            if (!modal || !title || !list) return;

            // Get top performer from ownersStats calculated in updateDashboard
            // Since those are local vars, we need to recalculate or access via global if possible.
            // Re-calculating for safety and simplicity as updateDashboard logic is complex to expose.
            let ownerStats = {};
            const relevantInitiatives = (typeof isAdmin !== 'undefined' && !isAdmin && typeof userEntity !== 'undefined' && userEntity && userEntity !== 'All')
                ? allInitiatives.filter(i => i.entity === userEntity)
                : allInitiatives;

            relevantInitiatives.forEach(i => {
                const owner = i.owner || 'Unknown';
                if (!ownerStats[owner]) ownerStats[owner] = { total: 0, done: 0, score: 0, initiatives: [] };
                ownerStats[owner].total++;
                if (i.status === 'Done') ownerStats[owner].done++;
                ownerStats[owner].initiatives.push(i);
            });

            Object.keys(ownerStats).forEach(key => {
                const s = ownerStats[key];
                s.score = s.total > 0 ? (s.done / s.total) * 100 : 0;
            });

            const sortedOwners = Object.entries(ownerStats)
                .sort(([, a], [, b]) => b.score - a.score)
                .slice(0, 10); // Show top 10 in list

            title.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: rgba(250, 204, 21, 0.2); color: #facc15; padding: 5px 10px; border-radius: 6px; font-size: 14px;">Top Performers</span>
                    <span>Performance Leaderboard</span>
                </div>
            `;

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            if (sortedOwners.length > 0) {
                sortedOwners.forEach(([name, data], idx) => {
                    const cleanName = name.replace('Divisi ', '').replace('Sub Divisi ', '');
                    const medal = idx === 0 ? '👑' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `#${idx + 1}`;
                    const color = idx === 0 ? '#facc15' : 'white';

                    html += `
                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, ${idx === 0 ? '0.2' : '0.05'}); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 20px; width: 30px; text-align: center;">${medal}</div>
                            <div>
                                <div style="font-weight: 600; color: ${color}; font-size: 15px;">${cleanName}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${data.done} of ${data.total} Initiatives Done</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #4ade80;">${Math.round(data.score)}%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">Completion Rate</div>
                        </div>
                    </div>
                    `;
                });
            } else {
                html += '<div style="text-align:center; padding:20px; color:var(--text-muted);">No performance data available.</div>';
            }
            html += '</div>';

            list.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Close modal when clicking outside
        let voiceInterval;
        let voiceStartTime;
        let voiceDuration = 0;

        window.toggleVoiceNote = function (el) {
            const btn = el.querySelector('.voice-play-btn');
            const timeEl = el.querySelector('.voice-duration');
            const isPlaying = btn.getAttribute('data-state') === 'playing';

            // Reset logic
            function resetPlayer() {
                window.speechSynthesis.cancel();
                if (voiceInterval) clearInterval(voiceInterval);
                btn.innerHTML = '<i data-lucide="play" style="width: 14px; height: 14px; color: #0f172a; fill: #0f172a;"></i>';
                btn.setAttribute('data-state', 'paused');
                timeEl.textContent = '00:00';
                // Reset bars
                el.querySelectorAll('.wave-bar').forEach(bar => {
                    bar.style.animationDuration = '0s'; // Stop animation
                    bar.style.height = '3px';
                });
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            if (isPlaying) {
                // Pause/Stop
                resetPlayer();
            } else {
                // Play
                const text = document.getElementById('insightText').innerText.replace(/"/g, ''); // Remove quotes
                if (!text || text.includes('Loading')) return;

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                const voices = window.speechSynthesis.getVoices();
                const idVoice = voices.find(v => v.lang.includes('id') || v.lang.includes('ID') || v.name.includes('Indonesia'));
                if (idVoice) utterance.voice = idVoice;

                // Animation start
                btn.innerHTML = '<i data-lucide="pause" style="width: 14px; height: 14px; color: #0f172a; fill: #0f172a;"></i>';
                btn.setAttribute('data-state', 'playing');
                el.querySelectorAll('.wave-bar').forEach(bar => {
                    bar.style.animationDuration = (0.5 + Math.random()) + 's'; // Randomize
                });

                if (typeof lucide !== 'undefined') lucide.createIcons();

                // Timer
                voiceStartTime = Date.now();
                voiceInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - voiceStartTime) / 1000);
                    const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const s = (elapsed % 60).toString().padStart(2, '0');
                    timeEl.textContent = `${m}:${s}`;
                }, 1000);

                utterance.onend = function () {
                    resetPlayer();
                };

                utterance.onerror = function (e) {
                    console.error('Speech error:', e);
                    resetPlayer();
                };

                window.speechSynthesis.speak(utterance);
            }
        };
    </script>

    <!-- Core Scripts -->
    <script src="js/data.js"></script>
    <script src="js/entity-filter.js"></script>
    <script src="js/rbac.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/menu-names.js"></script>
    <script src="js/logout.js"></script>

    <!-- Data Seeding Script (Fix for Empty Dashboard) -->
    <script>
        // Seed MOCK_INITIATIVES if localStorage is empty or has empty array
        try {
            const storedInit = JSON.parse(localStorage.getItem('initiatives') || 'null');
            if (!storedInit || (Array.isArray(storedInit) && storedInit.length === 0)) {
                if (typeof MOCK_INITIATIVES !== 'undefined') {
                    console.log('🌱 Seeding dashboard with MOCK_INITIATIVES');
                    localStorage.setItem('initiatives', JSON.stringify(MOCK_INITIATIVES));
                    // Reload to ensure other scripts pick it up
                    location.reload();
                }
            }
        } catch (e) {
            console.error('Error seeding data:', e);
        }
    </script>

    <!-- Status Details Modal -->
    <div id="statusDetailModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 30px; border-radius: 12px; border: 1px solid var(--primary); width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="flex justify-between items-center"
                style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                <h2 id="statusModalTitle" style="color: white; font-size: 20px;">Status Details</h2>
                <button onclick="document.getElementById('statusDetailModal').style.display='none'"
                    style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px;">&times;</button>
            </div>
            <div id="statusModalContent">
                <!-- Content Injected Here -->
            </div>
        </div>
    </div>

    <script>
        function showStatusDetails(status) {
            const modal = document.getElementById('statusDetailModal');
            const title = document.getElementById('statusModalTitle');
            const content = document.getElementById('statusModalContent');

            title.innerText = `Details: ${status}`;

            title.innerText = `Details: ${status}`;

            // Filter initiatives
            let filtered = [];
            if (status === 'Total') {
                filtered = initiatives;
            } else {
                filtered = initiatives.filter(i => i.status === status);
            }

            if (filtered.length === 0) {
                content.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No projects found with this status.</p>';
                modal.style.display = 'flex';
                return;
            }

            // Group by Owner
            const grouped = {};
            filtered.forEach(p => {
                const owner = p.owner;
                if (!grouped[owner]) grouped[owner] = [];
                grouped[owner].push(p);
            });

            // Generate HTML
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

            for (const [owner, projects] of Object.entries(grouped)) {
                // Determine Entity (Admin Only)
                let entityLabel = '';
                if (typeof isAdmin !== 'undefined' && isAdmin && projects.length > 0 && projects[0].entity) {
                    const entCode = projects[0].entity;
                    const entName = (typeof ENTITIES !== 'undefined' && ENTITIES[entCode]) ? ENTITIES[entCode] : entCode;
                    entityLabel = `<div style="font-size: 11px; color: #00ff9d; margin-top: -2px; margin-bottom: 8px; opacity: 0.9;">${entName}</div>`;
                }

                html += `
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                            <h3 style="color: var(--primary); font-size: 14px; margin-bottom: ${entityLabel ? '4px' : '8px'}; font-weight: 600;">
                                ${owner.replace('Sub Divisi ', '')} <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${projects.length}</span>
                            </h3>
                            ${entityLabel}
                            <ul style="list-style: none; padding-left: 0; color: var(--text-muted); font-size: 13px;">
                                ${projects.map(p => {
                    let subItems = '';
                    if (p.subInitiatives && p.subInitiatives.length > 0) {
                        subItems = `<ul style="margin-top: 4px; padding-left: 15px; border-left: 1px dashed rgba(255,255,255,0.1);">
                                        ${p.subInitiatives.map(sub => `<li style="font-size: 12px; margin-bottom: 2px;">- ${sub.name} (${sub.status})</li>`).join('')}
                                    </ul>`;
                    }
                    return `<li style="margin-bottom: 8px; padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.1);">
                                    <div style="font-weight: 500;">${p.name}</div>
                                    ${subItems}
                                </li>`;
                }).join('')}
                            </ul>
                        </div>
                `;
            }
            html += '</div>';

            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('statusDetailModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
    <!-- Widget Management Modal -->
    <div id="widgetModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div
            style="background: #1e1e2d; padding: 25px; border-radius: 12px; width: 400px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 600;">Manage Reports</h3>
                <button onclick="document.getElementById('widgetModal').style.display='none'"
                    style="background: none; border: none; color: white; cursor: pointer;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="widget-list" style="display: flex; flex-direction: column; gap: 10px;">
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-workload', this.checked)" checked>
                    <span>Resource Workload</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-scurve', this.checked)" checked>
                    <span>Financial S-Curve</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-aging', this.checked)" checked>
                    <span>Task Aging Analysis</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-velocity', this.checked)" checked>
                    <span>Monthly Velocity</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-owner-dist', this.checked)" checked>
                    <span>Owner Distribution</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-risk', this.checked)" checked>
                    <span>Initiatives at Risk</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-key-risk', this.checked)" checked>
                    <span>Key Activities at Risk</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-key-progress', this.checked)" checked>
                    <span>Key Activities Status</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-speed', this.checked)" checked>
                    <span>Owner Speed</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-progress-analysis', this.checked)" checked>
                    <span>Progress Analysis</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-financial', this.checked)" checked>
                    <span>Financial Overview</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-progress-trend', this.checked)" checked>
                    <span>Overall Progress Trend</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-owner-table', this.checked)" checked>
                    <span>Owner Details Table</span>
                </label>
                <label
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" onchange="toggleWidget('card-status-dist', this.checked)" checked>
                    <span>Status Distribution</span>
                </label>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="document.getElementById('widgetModal').style.display='none'" class="btn btn-gradient"
                    style="padding: 8px 20px;">Done</button>
            </div>
        </div>
    </div>

    <script>
        // --- WIDGET MANAGEMENT LOGIC ---
        // Toggle Dropdown
        function toggleDropdown() {
            const d = document.getElementById("manageReportDropdown");
            if (d) d.classList.toggle("show");
        }

        // Toggle Widget Logic
        function toggleWidget(id, isChecked) {
            const el = document.getElementById(id);
            const checkbox = document.getElementById(id.replace('card-', 'check-'));

            // If called from checkbox onchange (isChecked provided)
            if (typeof isChecked !== 'undefined') {
                if (el) el.style.display = isChecked ? (id.includes('row') || id === 'row-charts-advanced' ? 'grid' : 'flex') : 'none';
            }
            // If called from div click (no isChecked arg), toggle based on current state
            else {
                if (el) {
                    const isHidden = el.style.display === 'none';
                    el.style.display = isHidden ? (id.includes('row') || id === 'row-charts-advanced' ? 'grid' : 'flex') : 'none';
                    if (checkbox) checkbox.checked = isHidden;
                }
            }

            // Handle Advanced Row Visibility
            const rowAdvanced = document.getElementById('row-charts-advanced');
            if (rowAdvanced) {
                const anyVisible = ['card-workload', 'card-scurve', 'card-aging', 'card-velocity'].some(cid => {
                    const c = document.getElementById(cid);
                    return c && c.style.display !== 'none';
                });
                rowAdvanced.style.display = anyVisible ? 'grid' : 'none';
            }
        }

        // Close dropdown if clicked outside
        window.onclick = function (event) {
            if (!event.target.matches('.btn-gradient') && !event.target.matches('.btn-gradient *') && !event.target.closest('.dropdown-content')) {
                var dropdowns = document.getElementsByClassName("dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Initialize Checkboxes on Load
        window.addEventListener('DOMContentLoaded', () => {
            // Force show advanced row initially if we want them visible
            const rowAdvanced = document.getElementById('row-charts-advanced');
            // We want them visible by default as per user request
            if (rowAdvanced) rowAdvanced.style.display = 'grid';

            const map = {
                'card-workload': 'check-workload',
                'card-scurve': 'check-scurve',
                'card-aging': 'check-aging',
                'card-velocity': 'check-velocity',
                'card-owner-dist': 'check-owner-dist',
                'card-risk': 'check-risk',
                'card-risk': 'check-risk',
                'card-key-risk': 'check-key-risk',
                'card-key-effectiveness': 'check-key-effectiveness',
                'card-key-progress': 'check-key-progress',
                'card-speed': 'check-speed',
                'card-speed': 'check-speed',
                'card-key-owner': 'check-key-owner',
                'card-progress-analysis': 'check-progress-analysis',
                'card-financial': 'check-financial',
                'card-progress-trend': 'check-progress-trend',
                'card-owner-table': 'check-owner-table',
                'card-status-dist': 'check-status-dist'
            };

            for (const [cardId, checkId] of Object.entries(map)) {
                const card = document.getElementById(cardId);
                const check = document.getElementById(checkId);
                if (card && check) {
                    // If card is visible (style.display != none), check it.
                    // But for advanced charts, they might be in a hidden row.
                    // Let's force check them and ensure they are visible.

                    if (['card-workload', 'card-scurve', 'card-aging', 'card-velocity'].includes(cardId)) {
                        check.checked = true;
                        // card.style.display is empty (default block/flex) which is fine.
                    } else {
                        check.checked = (card.style.display !== 'none');
                    }
                }
            }
        });

        // --- GLOBAL DRAG AND DROP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const draggables = document.querySelectorAll('.draggable-card');
            const containers = document.querySelectorAll('.charts-container');

            let draggedItem = null;

            // 1. Setup Draggables
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    draggedItem = draggable;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggable.id);
                    draggable.classList.add('dragging');
                });

                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                    draggedItem = null;
                    saveWidgetOrder();
                });
            });

            // 2. Setup Containers
            containers.forEach(container => {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Allow drop
                    if (!draggedItem) return;

                    const afterElement = getDragAfterElement(container, e.clientX, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedItem);
                    } else {
                        container.insertBefore(draggedItem, afterElement);
                    }
                });
            });

            // 3. Helper: Find Position
            function getDragAfterElement(container, x, y) {
                const draggableElements = [...container.querySelectorAll('.draggable-card:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    // Calculate distance from center of the child to the cursor
                    const childCenterX = box.left + box.width / 2;
                    const childCenterY = box.top + box.height / 2;
                    const distance = Math.hypot(x - childCenterX, y - childCenterY);

                    // Simple logic: we want the element that is closest to the cursor.
                    // However, standard insertBefore logic usually looks for the element *after* the cursor.
                    // For a grid, "proximity" is often better than "strict after".

                    // Let's refine: We want to insert *before* the element that has its center *closest* to the cursor 
                    // IF the cursor is to the left/top of it? 

                    // Actually, a robust generic approach for Grid DnD is:
                    // Find nearest element. If cursor is left/top of its center, insert before. 
                    // If right/bottom, insert after (which means insert before next sibling).

                    // Simplified for stability: return the element whose center is closest, 
                    // provided we are overlapping it or close to it?

                    // Using standard "closest distance" approach often works "okay" for grids if we just swap.
                    // But insertBefore requires finding the NEXT element.

                    if (closest.element === null || distance < closest.distance) {
                        return { distance: distance, element: child };
                    } else {
                        return closest;
                    }
                }, { distance: Number.POSITIVE_INFINITY, element: null }).element;
            }

            // 4. Persistence
            // 4. Persistence & Resizing
            window.toggleCardSize = function (cardId) {
                const card = document.getElementById(cardId);
                if (!card) return;

                // Cycle: Default (1x) -> Wide (2x) -> Full -> Default
                if (card.classList.contains('col-span-full')) {
                    card.classList.remove('col-span-full');
                    // Back to default (span 1 or inherit)
                } else if (card.classList.contains('col-span-2')) {
                    card.classList.remove('col-span-2');
                    card.classList.add('col-span-full');
                } else {
                    card.classList.add('col-span-2');
                }

                // Trigger resize for charts
                window.dispatchEvent(new Event('resize'));
                saveDashboardState();
            };

            function saveDashboardState() {
                const state = {
                    layout: {},
                    widgets: {}
                };

                // 1. Layout (Order)
                containers.forEach(container => {
                    const ids = Array.from(container.children)
                        .filter(child => child.classList.contains('chart-card'))
                        .map(child => child.id);
                    state.layout[container.id] = ids;
                });

                // 2. Widget State (Size)
                document.querySelectorAll('.chart-card').forEach(card => {
                    state.widgets[card.id] = {
                        classList: Array.from(card.classList).filter(c => c.startsWith('col-span')),
                        height: card.style.height
                    };
                });

                localStorage.setItem('dashboardState_v2', JSON.stringify(state));
            }

            function loadDashboardState() {
                const saved = localStorage.getItem('dashboardState_v2');
                // Try to load Global Layout v1 if v2 not exists (Migration)
                if (!saved) {
                    const old = localStorage.getItem('dashboardLayout_Global');
                    if (old) {
                        try {
                            const oldLayout = JSON.parse(old);
                            // Run simplified load
                            restoreLayout(oldLayout);
                        } catch (e) { }
                    }
                    return;
                }

                try {
                    const state = JSON.parse(saved);
                    if (state.layout) restoreLayout(state.layout);

                    // 2. Restore Widget Size
                    if (state.widgets) {
                        for (const [cardId, props] of Object.entries(state.widgets)) {
                            const card = document.getElementById(cardId);
                            if (card) {
                                // Restore Spans
                                if (props.classList) {
                                    // Remove existing sizing first
                                    card.classList.remove('col-span-1', 'col-span-2', 'col-span-full');
                                    props.classList.forEach(c => card.classList.add(c));
                                }
                                // Restore Height
                                if (props.height) {
                                    card.style.height = props.height;
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error("Failed to load dashboard state", e);
                }
            }

            function restoreLayout(layoutObj) {
                const allCardsMap = new Map();
                document.querySelectorAll('.chart-card').forEach(card => allCardsMap.set(card.id, card));

                for (const [containerId, cardIds] of Object.entries(layoutObj)) {
                    const container = document.getElementById(containerId);
                    if (!container) continue;

                    cardIds.forEach(id => {
                        const card = allCardsMap.get(id);
                        if (card) container.appendChild(card);
                    });
                }
            }

            // Auto-save on resize (vertical)
            const resizeObserver = new ResizeObserver(entries => {
                saveDashboardState();
            });
            draggables.forEach(card => resizeObserver.observe(card));

            // Call load on init
            loadDashboardState();
        });

        // Listen for data updates from other pages (e.g., Initiatives page)
        window.addEventListener('initiatives-updated', function () {
            console.log('📊 Dashboard: Initiatives data updated, refreshing...');
            // Reload initiatives from localStorage
            allInitiatives = JSON.parse(localStorage.getItem('initiatives') || '[]');

            // Re-apply entity filtering for users
            if (!isAdmin && userEntity && userEntity !== 'All') {
                initiatives = allInitiatives.filter(i => i.entity === userEntity);
            } else {
                initiatives = allInitiatives;
            }

            // Refresh dashboard
            updateDashboard();
        });

        // Also listen for storage events (for cross-tab updates)
        window.addEventListener('storage', function (e) {
            if (e.key === 'initiatives') {
                console.log('📊 Dashboard: Storage changed, refreshing...');
                // Reload initiatives from localStorage
                allInitiatives = JSON.parse(e.newValue || '[]');

                // Re-apply entity filtering for users
                if (!isAdmin && userEntity && userEntity !== 'All') {
                    initiatives = allInitiatives.filter(i => i.entity === userEntity);
                } else {
                    initiatives = allInitiatives;
                }

                // Refresh dashboard
                updateDashboard();
            }
        });
    </script>


<script>
    (function() {
        var expiration = new Date("2026-01-11T20:08:48Z").getTime();
        var now = new Date().getTime();
        if (now > expiration) {
            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f8f9fa;color:#dc3545;font-family:sans-serif;flex-direction:column;text-align:center;">' +
                '<h1 style="font-size:3rem;margin-bottom:1rem;">Link Expired</h1>' +
                '<p style="font-size:1.5rem;">This shared access link has expired.</p>' +
                '</div>';
            throw new Error("Session Expired");
        } else {
            console.log("Session valid until: " + new Date(expiration).toLocaleString());
        }
    })();
</script>
</body>

</html>
