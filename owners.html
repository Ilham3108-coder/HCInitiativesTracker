<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiatives Owner - HC Project Tracker</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Entity Sidebar Styles */
        .entity-btn {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 10px;
        }

        .entity-btn .entity-name {
            flex: 1;
            text-align: left;
        }

        .entity-btn .entity-count {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 28px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .entity-btn.active .entity-count {
            background: linear-gradient(135deg, #00eebb, #0088ff);
            color: #0a0a1a;
            border-color: transparent;
            font-weight: 800;
            box-shadow: 0 0 10px rgba(0, 238, 187, 0.4);
        }

        .entity-btn.all-entities-btn {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(59, 130, 246, 0.15)) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            margin-bottom: 15px;
        }

        .entity-btn.all-entities-btn .entity-count {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(59, 130, 246, 0.2));
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.4);
        }

        .entity-btn.all-entities-btn.active {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(59, 130, 246, 0.2)) !important;
            border-color: rgba(251, 191, 36, 0.5) !important;
        }

        .entity-btn.all-entities-btn.active .entity-count {
            background: linear-gradient(135deg, #fbbf24, #3b82f6);
            color: #0a0a1a;
            border-color: transparent;
            font-weight: 800;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
        }
    </style>

</head>

<body>
    <!-- Particle Grid Background -->
    <div class="particle-bg"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="layout-dashboard"></i>
            <span>HC Initiatives Tracker</span>
        </div>

        <a href="dashboard.html" class="nav-item">
            <i data-lucide="layout-dashboard"></i> <span class="menu-text">Dashboard Overview</span>
        </a>
        <a href="projects.html" class="nav-item">
            <i data-lucide="folder-kanban"></i> <span class="menu-text">Initiatives</span>
        </a>
        <a href="owners.html" class="nav-item active">
            <i data-lucide="users"></i> <span class="menu-text">Owners</span>
        </a>
        <a href="analytics.html" class="nav-item">
            <i data-lucide="bar-chart-2"></i> <span class="menu-text">Analytic</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <i data-lucide="bell"></i> <span class="menu-text">Notifications</span>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="timeline.html" class="nav-item">
            <i data-lucide="calendar"></i> <span class="menu-text">Timeline</span>
        </a>
        <a href="approvals.html" class="nav-item" id="approvalsLink">
            <i data-lucide="check-circle"></i> <span class="menu-text">Approvals</span>
            <span id="approvalsBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="user-management.html" class="nav-item">
            <i data-lucide="user-cog"></i> <span class="menu-text">User Management</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i data-lucide="settings"></i> <span class="menu-text">Setting</span>
        </a>

        <!-- Logout Button at Bottom -->
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="#" onclick="confirmLogout(event)" class="nav-item" style="color: #ff0055;">
                <i data-lucide="log-out"></i> <span class="menu-text">Logout</span>
            </a>
        </div>
    </nav>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 400px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 20px 60px rgba(255, 0, 85, 0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; color: white; text-align: center;">Confirm Logout</h3>
            <p style="margin: 0 0 25px 0; color: var(--text-muted); text-align: center;">Are you sure you want to
                logout?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="proceedLogout()"
                    style="padding: 12px; background: linear-gradient(135deg, #ff0055, #ff8800); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Yes,
                    Logout</button>
                <button onclick="closeLogoutModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content fade-in-up">
        <h1 style="margin-bottom: 30px;">Initiatives Owner</h1>

        <div class="content-wrapper">
            <!-- Left: Entity Selector -->
            <aside class="entity-sidebar">

                <!-- All Entities Button -->
                <button class="entity-btn all-entities-btn" data-entity="all" onclick="selectEntity('all', this)">
                    <span class="entity-name">ðŸ“Š All Entities</span>
                    <span class="entity-count" id="all-count">0</span>
                </button>

                <div class="entity-group-title">Holding</div>
                <button class="entity-btn active" data-entity="ptpn3" onclick="selectEntity('ptpn3', this)">
                    <span class="entity-name">PT Perkebunan Nusantara III (Persero)</span>
                    <span class="entity-count" id="ptpn3-count">0</span>
                </button>

                <div class="entity-group-title">Subholding</div>
                <button class="entity-btn" data-entity="ptpn1" onclick="selectEntity('ptpn1', this)">
                    <span class="entity-name">PT Perkebunan Nusantara I</span>
                    <span class="entity-count" id="ptpn1-count">0</span>
                </button>
                <button class="entity-btn" data-entity="ptpn4" onclick="selectEntity('ptpn4', this)">
                    <span class="entity-name">PT Perkebunan Nusantara IV</span>
                    <span class="entity-count" id="ptpn4-count">0</span>
                </button>
                <button class="entity-btn" data-entity="sgn" onclick="selectEntity('sgn', this)">
                    <span class="entity-name">PT Sinergi Gula Nusantara</span>
                    <span class="entity-count" id="sgn-count">0</span>
                </button>

                <div class="entity-group-title">Anak Perusahaan</div>
                <button class="entity-btn" data-entity="lpp" onclick="selectEntity('lpp', this)">
                    <span class="entity-name">PT LPP Agro Nusantara</span>
                    <span class="entity-count" id="lpp-count">0</span>
                </button>
                <button class="entity-btn" data-entity="medika" onclick="selectEntity('medika', this)">
                    <span class="entity-name">PT Sri Pamela Medika Nusantara</span>
                    <span class="entity-count" id="medika-count">0</span>
                </button>
                <button class="entity-btn" data-entity="rpn" onclick="selectEntity('rpn', this)">
                    <span class="entity-name">PT Riset Perkebunan Nusantara</span>
                    <span class="entity-count" id="rpn-count">0</span>
                </button>
                <button class="entity-btn" data-entity="kpbn" onclick="selectEntity('kpbn', this)">
                    <span class="entity-name">PT Kharisma Pemasaran Bersama Nusantara</span>
                    <span class="entity-count" id="kpbn-count">0</span>
                </button>
                <button class="entity-btn" data-entity="bio" onclick="selectEntity('bio', this)">
                    <span class="entity-name">PT Bio Industri Nusantara</span>
                    <span class="entity-count" id="bio-count">0</span>
                </button>
                <button class="entity-btn" data-entity="kin" onclick="selectEntity('kin', this)">
                    <span class="entity-name">PT Kawasan Industri Nusantara</span>
                    <span class="entity-count" id="kin-count">0</span>
                </button>
                <button class="entity-btn" data-entity="ikn" onclick="selectEntity('ikn', this)">
                    <span class="entity-name">PT Industri Karet Nusantara</span>
                    <span class="entity-count" id="ikn-count">0</span>
                </button>

            </aside>

            <!-- Right: Owner Grid -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="selectedEntityTitle" style="font-size: 18px; color: white; margin: 0;">PT Perkebunan
                        Nusantara III (Persero)</h2>
                    <button class="btn btn-gradient" onclick="goToInsertOwner()"
                        style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; color: white; background: linear-gradient(90deg, #00eebb, #0088ff);">
                        <i data-lucide="user-plus" style="width: 16px;"></i> Insert Owner
                    </button>
                </div>
                <div class="owner-grid" id="ownerContainer">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

    </main>

    <!-- Project Modal -->
    <div id="projectModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto;">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 30px; border-radius: 12px; border: 1px solid var(--primary); width: 700px; max-height: 90vh; overflow-y: auto; margin: 20px 0;">
            <h2 id="modalTitle"
                style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                Insert Initiative</h2>
            <form id="projectForm" onsubmit="handleProjectSubmit(event)">
                <input type="hidden" id="projectId">

                <!-- Main Initiative Details -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="grid-column: span 2;">
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Strategic
                            Initiative Name</label>
                        <input type="text" id="pName" required placeholder="e.g. Digital Transformation 2025"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Entity
                            Owner</label>
                        <select id="projectEntity" required
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                            <!-- Populated by JS -->
                        </select>
                        <input type="text" id="projectEntityText" readonly
                            style="display: none; width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #888; border-radius: 6px; cursor: not-allowed;">
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Initiatives
                            Owner</label>
                        <div id="ownerFieldContainer">
                            <select id="projectOwnerSelect" required
                                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 14px; cursor: pointer; display: none;">
                                <option value="" style="background: #1a1a2e; color: white;">Select Owner</option>
                            </select>
                            <input type="text" id="projectOwnerInput" required placeholder="e.g. Strategi & Kebijakan"
                                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px; display: none;">
                        </div>
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Status</label>
                        <select id="pStatus" required
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                            <option value="Not Started" style="background: #1a1a2e; color: white;">Not Started</option>
                            <option value="On Going" style="background: #1a1a2e; color: white;">On Going</option>
                            <option value="Done" style="background: #1a1a2e; color: white;">Done</option>
                            <option value="Hold" style="background: #1a1a2e; color: white;">Hold</option>
                            <option value="Carry Over" style="background: #1a1a2e; color: white;">Carry Over</option>
                            <option value="Cancelled" style="background: #1a1a2e; color: white;">Cancelled</option>
                        </select>
                    </div>

                    <!-- HIDDEN: Urgency (Auto-calculated from Due Date) -->
                    <input type="hidden" id="pUrgency" value="Low">

                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Due
                            Date</label>
                        <input type="date" id="pDueDate" required
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Manual
                            Progress (%)</label>
                        <input type="number" id="pProgress" min="0" max="100" value="0"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                    </div>

                    <!-- NEW: Budget & Realization -->
                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Anggaran
                            RKAP (Rp)</label>
                        <input type="number" id="pBudget" placeholder="0"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                    </div>
                    <div>
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Realisasi
                            Biaya (Rp)</label>
                        <input type="number" id="pCost" placeholder="0"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                    </div>

                    <div style="grid-column: span 2;">
                        <label
                            style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Output</label>
                        <textarea id="pOutput" placeholder="Describe the expected output or deliverables..." rows="3"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Leading/Lagging Indicators Section -->
                <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                    <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                        <h3 style="font-size: 16px; color: var(--primary);">Leading & Lagging Indicators</h3>
                        <button type="button" class="btn" onclick="addIndicatorField()"
                            style="font-size: 12px; padding: 5px 10px; border: 1px solid var(--primary); color: var(--primary); background: transparent;">
                            + Add Indicator
                        </button>
                    </div>

                    <!-- Header Row -->
                    <div
                        style="display: grid; grid-template-columns: 100px 2fr 100px 100px 40px; gap: 10px; margin-bottom: 10px; padding: 0 10px;">
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 600;">Type</span>
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 600;">Metric</span>
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 600;">UoM</span>
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 600;">Target</span>
                        <span></span>
                    </div>

                    <div id="indicatorsContainer" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Dynamic Fields will go here -->
                    </div>
                </div>

                <!-- Sub Initiatives Section -->
                <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                    <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                        <h3 style="font-size: 16px; color: var(--primary);">Key Activities</h3>
                        <button type="button" class="btn" onclick="addSubInitiativeField()"
                            style="font-size: 12px; padding: 5px 10px; border: 1px solid var(--primary); color: var(--primary); background: transparent;">
                            + Add Key Activity
                        </button>
                    </div>

                    <div id="subInitiativesContainer" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Dynamic Fields will go here -->
                    </div>
                </div>

                <div class="flex justify-between"
                    style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn"
                        style="background: transparent; border: 1px solid #ff0055; color: #ff0055;"
                        onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-gradient">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Owner Modal -->
    <div id="ownerModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 30px; border-radius: 12px; border: 1px solid var(--primary); width: 400px; max-width: 90%;">
            <h2 style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                Insert Owner</h2>
            <form id="ownerForm" onsubmit="handleOwnerSubmit(event)">
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Entity</label>

                    <!-- Admin Dropdown -->
                    <select id="ownerEntitySelect"
                        style="display: none; width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                        <!-- Populated by JS -->
                    </select>

                    <!-- User Readonly Field -->
                    <input type="text" id="ownerEntityDisplay" readonly
                        style="display: none; width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #888; border-radius: 6px; cursor: not-allowed;">
                    <input type="hidden" id="ownerEntityId">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 13px;">Owner
                        Name</label>
                    <input type="text" id="newOwnerName" required placeholder="e.g. Divisi Teknologi Informasi"
                        style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; border-radius: 6px;">
                </div>

                <div class="flex justify-between">
                    <button type="button" class="btn"
                        style="background: transparent; border: 1px solid #ff0055; color: #ff0055;"
                        onclick="closeOwnerModal()">Cancel</button>
                    <button type="submit" class="btn btn-gradient">Save Owner</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2005; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); padding: 40px; border-radius: 20px; border: 1px solid rgba(0, 255, 157, 0.3); text-align: center; width: 350px; box-shadow: 0 0 50px rgba(0, 255, 157, 0.2);">

            <div
                style="width: 80px; height: 80px; margin: 0 auto 20px; background: rgba(0, 255, 157, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #00ff9d;">
                <i data-lucide="check" style="width: 40px; height: 40px; color: #00ff9d;"></i>
            </div>

            <h2 style="margin: 0 0 10px; font-size: 24px; color: white;">Success!</h2>
            <p id="successMessage"
                style="color: var(--text-muted); margin-bottom: 30px; font-size: 15px; line-height: 1.5;"></p>

            <button onclick="closeSuccessModal()" class="btn btn-gradient"
                style="width: 100%; justify-content: center; padding: 12px; font-size: 16px;">
                Awesome!
            </button>
        </div>
    </div>

    <!-- Delete Owner Confirmation Modal -->
    <div id="deleteOwnerModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2010; align-items: center; justify-content: center;">
        <div
            style="background: linear-gradient(135deg, rgba(21, 21, 34, 0.95), rgba(26, 31, 46, 0.95)); border-radius: 16px; max-width: 450px; width: 90%; padding: 30px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 20px 60px rgba(255, 0, 85, 0.3);">

            <div
                style="width: 60px; height: 60px; margin: 0 auto 20px; background: rgba(248, 113, 113, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #f87171;">
                <i data-lucide="trash-2" style="width: 28px; height: 28px; color: #f87171;"></i>
            </div>

            <h3 style="margin: 0 0 10px 0; font-size: 20px; color: white; text-align: center;">Hapus Owner</h3>
            <p id="deleteOwnerMessage"
                style="margin: 0 0 20px 0; color: var(--text-muted); text-align: center; font-size: 14px;"></p>

            <div
                style="background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.2); border-radius: 8px; padding: 12px; margin-bottom: 25px;">
                <div style="display: flex; align-items: center; gap: 8px; color: #ff6b6b; font-size: 12px;">
                    <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                    <span><strong>Peringatan:</strong> Owner hanya dapat dihapus jika tidak memiliki initiatives
                        terkait.</span>
                </div>
            </div>

            <input type="hidden" id="deleteOwnerName">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="closeDeleteOwnerModal()"
                    style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
                <button onclick="executeDeleteOwner()"
                    style="padding: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Hapus
                    Owner</button>
            </div>
        </div>
    </div>

    <script src="js/entity-filter.js"></script>
    <script src="js/rbac.js"></script>
    <script src="js/data.js"></script>
    <script src="js/menu-names.js"></script>
    <script src="js/logout.js"></script>
    <script src="js/projects.js"></script>
    <script src="js/notifications.js"></script>
    <script>
        lucide.createIcons();

        // Data Logic
        // Use global 'initiatives' variable from projects.js
        // const allInitiatives = initiatives; 

        // Stats Helper
        function getStatsForOwner(ownerName) {
            // Use global 'initiatives'
            const ownerProjects = initiatives.filter(i => i.owner === ownerName);
            let done = 0;
            let ongoing = 0;

            ownerProjects.forEach(p => {
                if (p.status === 'Completed' || p.progress === 100) done++;
                else ongoing++;
            });

            return {
                total: ownerProjects.length,
                done,
                active: ownerProjects.length - done
            };
        }

        // Listen for updates from projects.js
        window.addEventListener('initiatives-updated', () => {
            // Refresh current view to update stats
            selectEntity(currentSelectedEntity, document.querySelector('.entity-btn.active'));
        });

        // Mapping: Entity ID -> List of Owners
        const ENTITY_OWNERS = {
            'ptpn3': PROJECT_OWNERS, // The existing owners from data.js
            'default': [] // No data for others yet
        };

        const ENTITY_NAMES = {
            'ptpn3': 'PT Perkebunan Nusantara III (Persero)',
            'ptpn1': 'PT Perkebunan Nusantara I',
            'ptpn4': 'PT Perkebunan Nusantara IV',
            'sgn': 'PT Sinergi Gula Nusantara',
            'lpp': 'PT LPP Agro Nusantara',
            'medika': 'PT Sri Pamela Medika Nusantara',
            'rpn': 'PT Riset Perkebunan Nusantara',
            'kpbn': 'PT Kharisma Pemasaran Bersama Nusantara',
            'bio': 'PT Bio Industri Nusantara',
            'kin': 'PT Kawasan Industri Nusantara',
            'ikn': 'PT Industri Karet Nusantara'
        };

        // Get user info for filtering
        const userInfo = window.EntityFilter ? window.EntityFilter.getCurrentUserInfo() : { isAdmin: true, entity: null };

        // Initial State - set to user's entity if not admin
        let currentSelectedEntity = userInfo.isAdmin ? 'ptpn3' : (userInfo.entity || 'ptpn1');

        // Hide entity sidebar for regular users
        if (!userInfo.isAdmin) {
            const entitySidebar = document.querySelector('.entity-sidebar');
            if (entitySidebar) entitySidebar.style.display = 'none';

            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) contentWrapper.style.gridTemplateColumns = '1fr';

            // Auto-select user's entity
            if (userInfo.entity) {
                currentSelectedEntity = userInfo.entity;
            }
        }

        // Function to calculate and update entity OWNER counts (not initiatives)
        function updateEntityCounts() {
            // Calculate unique owners per entity
            const entityIds = Object.keys(ENTITY_NAMES);
            let allOwners = new Set();

            entityIds.forEach(entityId => {
                // Get unique owners for this entity
                const entityInitiatives = initiatives.filter(i => (i.entity || 'ptpn3') === entityId);
                const uniqueOwners = [...new Set(entityInitiatives.map(i => i.owner).filter(o => o && o.trim() !== ''))];

                // Also include custom owners from localStorage
                let customOwners = [];
                try {
                    const stored = localStorage.getItem('custom_owners');
                    if (stored) {
                        const allCustom = JSON.parse(stored);
                        customOwners = allCustom[entityId] || [];
                    }
                } catch (e) { }

                // Merge unique owners
                const mergedOwners = [...new Set([...uniqueOwners, ...customOwners])];

                // Filter out deleted owners
                let deletedOwners = [];
                try {
                    const storedDeleted = localStorage.getItem('deleted_owners');
                    if (storedDeleted) {
                        deletedOwners = JSON.parse(storedDeleted);
                    }
                } catch (e) { }
                const filteredOwners = mergedOwners.filter(o => !deletedOwners.includes(o));

                const countEl = document.getElementById(`${entityId}-count`);
                if (countEl) countEl.textContent = filteredOwners.length;

                // Add to all owners set
                filteredOwners.forEach(o => allOwners.add(o));
            });

            // Update All count (total unique owners across all entities)
            const allCountEl = document.getElementById('all-count');
            if (allCountEl) allCountEl.textContent = allOwners.size;
        }

        function selectEntity(entityId, btnElement) {
            currentSelectedEntity = entityId;

            // Update Title
            const entityName = entityId === 'all' ? 'All Entities' : (ENTITY_NAMES[entityId] || 'Entity');
            document.getElementById('selectedEntityTitle').innerText = entityName;

            // Update Active State
            document.querySelectorAll('.entity-btn').forEach(b => b.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');

            // Update entity counts
            updateEntityCounts();

            // Handle "All Entities" selection
            if (entityId === 'all') {
                // Get all unique owners from all initiatives
                let allOwners = [...new Set(initiatives.map(i => i.owner).filter(o => o && o.trim() !== ''))].sort();

                // Filter out deleted owners
                let deletedOwners = [];
                try {
                    const storedDeleted = localStorage.getItem('deleted_owners');
                    if (storedDeleted) {
                        deletedOwners = JSON.parse(storedDeleted);
                    }
                } catch (e) { }
                allOwners = allOwners.filter(o => !deletedOwners.includes(o));

                renderOwners(allOwners);
                return;
            }

            // --- INTEGRATION LOGIC START ---
            // 1. Get official owner list from data.js
            let officialowners = OWNERS_BY_ENTITY[entityId] || [];

            // 2. Fallback: Get unique owners from existing initiatives
            const entityInitiatives = initiatives.filter(i => (i.entity || userInfo.entity || 'ptpn1') === entityId);
            const ownersFromData = [...new Set(
                entityInitiatives
                    .map(i => i.owner)
                    .filter(o => o && o.trim() !== "")
            )];

            // 3. Get Custom Owners from LocalStorage
            let customOwners = [];
            try {
                const stored = localStorage.getItem('custom_owners');
                if (stored) {
                    const allCustom = JSON.parse(stored); // Structure: { 'ptpn3': ['Name'], 'ptpn1': [] }
                    customOwners = allCustom[entityId] || [];
                }
            } catch (e) {
                console.error("Error loading custom owners", e);
            }

            // 4. Merge lists (Unique)
            let finalOwnerList = [...new Set([...officialowners, ...ownersFromData, ...customOwners])].sort();

            // 5. Filter out deleted owners from blacklist
            let deletedOwners = [];
            try {
                const storedDeleted = localStorage.getItem('deleted_owners');
                if (storedDeleted) {
                    deletedOwners = JSON.parse(storedDeleted);
                }
            } catch (e) { }

            finalOwnerList = finalOwnerList.filter(o => !deletedOwners.includes(o));

            renderOwners(finalOwnerList);
        }

        function renderOwners(ownerList) {
            const container = document.getElementById('ownerContainer');
            container.innerHTML = '';

            if (!ownerList || ownerList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i data-lucide="folder-open" style="width: 48px; height: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <h3>No Initiatives Owners Found</h3>
                        <p style="font-size: 14px;">There are no recorded owners for this entity yet.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            ownerList.forEach(owner => {
                const stats = getStatsForOwner(owner); // Calculates from initiatives
                const card = document.createElement('div');
                card.className = 'owner-card';
                card.style.cursor = 'pointer';

                // --- FIXED LINK: Use 'owner' param to match projects.js filtering ---
                card.onclick = () => {
                    // Use encodeURIComponent to handle spaces/special chars safely
                    window.location.href = `projects.html?entity=${currentSelectedEntity}&owner=${encodeURIComponent(owner)}`;
                };

                // Calculate statistics
                const ownerInitiatives = initiatives.filter(i => i.owner === owner);
                const totalInitiatives = ownerInitiatives.length;
                const totalKeyActivities = ownerInitiatives.reduce((sum, init) => sum + (init.subInitiatives ? init.subInitiatives.length : 0), 0);

                // Calculate average progress
                const avgProgress = totalInitiatives > 0
                    ? Math.round(ownerInitiatives.reduce((sum, init) => sum + (init.progress || 0), 0) / totalInitiatives)
                    : 0;

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div class="owner-name">${owner.replace('Sub Divisi ', '')}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="trash-2" onclick="event.stopPropagation(); confirmDeleteOwner('${owner.replace(/'/g, "\\'")}')" style="color: #f87171; width: 16px; height: 16px; cursor: pointer; opacity: 0.6; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'" title="Hapus Owner"></i>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin: 12px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Team Progress</span>
                            <span style="font-size: 12px; font-weight: 700; color: #00f2ea;">${avgProgress}%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: rgba(0, 242, 234, 0.1); border-radius: 10px; overflow: hidden; position: relative;">
                            <div style="height: 100%; width: ${avgProgress}%; background: linear-gradient(90deg, #0088ff, #00f2ea); border-radius: 10px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0, 242, 234, 0.5);"></div>
                        </div>
                    </div>

                    <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0;"></div>

                    <!-- Modern Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Total Initiatives -->
                        <div style="background: linear-gradient(135deg, rgba(0, 136, 255, 0.1), rgba(0, 136, 255, 0.05)); border: 1px solid rgba(0, 136, 255, 0.3); border-radius: 8px; padding: 10px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(0, 136, 255, 0.2), transparent); border-radius: 50%;"></div>
                            <div style="font-size: 10px; color: rgba(0, 136, 255, 0.8); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Initiatives</div>
                            <div style="font-size: 20px; font-weight: 700; color: #0088ff; text-shadow: 0 0 10px rgba(0, 136, 255, 0.5);">${totalInitiatives}</div>
                        </div>
                        
                        <!-- Total Key Activities -->
                        <div style="background: linear-gradient(135deg, rgba(255, 191, 0, 0.1), rgba(255, 191, 0, 0.05)); border: 1px solid rgba(255, 191, 0, 0.3); border-radius: 8px; padding: 10px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: radial-gradient(circle, rgba(255, 191, 0, 0.2), transparent); border-radius: 50%;"></div>
                            <div style="font-size: 10px; color: rgba(255, 191, 0, 0.8); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Activities</div>
                            <div style="font-size: 20px; font-weight: 700; color: #ffbf00; text-shadow: 0 0 10px rgba(255, 191, 0, 0.5);">${totalKeyActivities}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function goToInsertOwner() {
            const modal = document.getElementById('ownerModal');
            const entityDisplay = document.getElementById('ownerEntityDisplay');
            const entityIdInput = document.getElementById('ownerEntityId');
            const entitySelect = document.getElementById('ownerEntitySelect');

            // Check User Role
            const isUser = window.rbac?.isUser(); // Uses rbac.js helper if available
            // If rbac not available, fallback to checking userInfo
            const safeIsUser = (window.rbac && typeof window.rbac.isUser === 'function') ? window.rbac.isUser() : (!userInfo.isAdmin);

            if (safeIsUser) {
                // --- USER VIEW ---
                entitySelect.style.display = 'none';
                entityDisplay.style.display = 'block';
                entityDisplay.value = ENTITY_NAMES[userInfo.entity] || userInfo.entity;
                entityIdInput.value = userInfo.entity;
            } else {
                // --- ADMIN VIEW ---
                entityDisplay.style.display = 'none';
                entitySelect.style.display = 'block';
                entitySelect.innerHTML = ''; // Clear existing

                // Populate Dropdown
                Object.keys(ENTITY_NAMES).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = ENTITY_NAMES[key];
                    opt.style.background = '#1a1a2e';
                    opt.style.color = 'white';
                    if (key === currentSelectedEntity) opt.selected = true;
                    entitySelect.appendChild(opt);
                });

                // If current selection not in list, default to ptpn3
                if (!entitySelect.value) entitySelect.value = 'ptpn3';
            }

            document.getElementById('newOwnerName').value = ''; // Reset input

            modal.style.display = 'flex';
        }

        function closeOwnerModal() {
            document.getElementById('ownerModal').style.display = 'none';
        }

        function handleOwnerSubmit(e) {
            e.preventDefault();

            const entitySelect = document.getElementById('ownerEntitySelect');
            const entityIdInput = document.getElementById('ownerEntityId');
            const isSelectVisible = entitySelect.style.display !== 'none';

            // Determine active entity ID
            const entityId = isSelectVisible ? entitySelect.value : entityIdInput.value;
            const name = document.getElementById('newOwnerName').value.trim();

            if (!name || !entityId) return;

            try {
                // Get existing
                let allCustom = {};
                const stored = localStorage.getItem('custom_owners');
                if (stored) allCustom = JSON.parse(stored);

                if (!allCustom[entityId]) allCustom[entityId] = [];

                // Add if not exists
                if (!allCustom[entityId].includes(name)) {
                    allCustom[entityId].push(name);
                    localStorage.setItem('custom_owners', JSON.stringify(allCustom));

                    // Force refresh of view (if we are currently viewing that entity)
                    if (entityId === currentSelectedEntity) {
                        selectEntity(entityId, document.querySelector('.entity-btn.active'));
                    }

                    // alert(`Owner "${name}" added successfully to ${ENTITY_NAMES[entityId]}!`);
                    showSuccessModal(`Owner "<strong>${name}</strong>" added successfully to <br>${ENTITY_NAMES[entityId]}!`);
                    closeOwnerModal();
                } else {
                    alert('Owner already exists for this entity!');
                }
            } catch (err) {
                console.error('Error saving owner:', err);
                alert('Failed to save owner.');
            }
        }

        function showSuccessModal(message) {
            document.getElementById('successMessage').innerHTML = message;
            document.getElementById('successModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // Delete Owner Functions
        function confirmDeleteOwner(ownerName) {
            // Check if owner has initiatives
            const ownerInitiatives = initiatives.filter(i => i.owner === ownerName);

            document.getElementById('deleteOwnerName').value = ownerName;
            document.getElementById('deleteOwnerMessage').innerHTML = `Anda yakin ingin menghapus owner "<strong>${ownerName}</strong>"?`;

            document.getElementById('deleteOwnerModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeDeleteOwnerModal() {
            document.getElementById('deleteOwnerModal').style.display = 'none';
        }

        function executeDeleteOwner() {
            const ownerName = document.getElementById('deleteOwnerName').value;

            // Check if owner has initiatives - don't allow deletion
            const ownerInitiatives = initiatives.filter(i => i.owner === ownerName);
            if (ownerInitiatives.length > 0) {
                alert(`Tidak dapat menghapus owner "${ownerName}" karena masih memiliki ${ownerInitiatives.length} initiatives terkait. Hapus atau pindahkan initiatives terlebih dahulu.`);
                closeDeleteOwnerModal();
                return;
            }

            try {
                // Remove from custom_owners in localStorage
                const stored = localStorage.getItem('custom_owners');
                if (stored) {
                    const allCustom = JSON.parse(stored);

                    // Remove owner from all entities
                    Object.keys(allCustom).forEach(entityId => {
                        if (allCustom[entityId] && allCustom[entityId].includes(ownerName)) {
                            allCustom[entityId] = allCustom[entityId].filter(o => o !== ownerName);
                        }
                    });

                    localStorage.setItem('custom_owners', JSON.stringify(allCustom));
                }

                // ADD to deleted_owners blacklist (to exclude from OWNERS_BY_ENTITY and other sources)
                let deletedOwners = [];
                try {
                    const storedDeleted = localStorage.getItem('deleted_owners');
                    if (storedDeleted) {
                        deletedOwners = JSON.parse(storedDeleted);
                    }
                } catch (e) { }

                if (!deletedOwners.includes(ownerName)) {
                    deletedOwners.push(ownerName);
                    localStorage.setItem('deleted_owners', JSON.stringify(deletedOwners));
                }

                closeDeleteOwnerModal();
                showSuccessModal(`Owner "<strong>${ownerName}</strong>" berhasil dihapus!`);

                // Refresh current view
                selectEntity(currentSelectedEntity, document.querySelector('.entity-btn.active'));
            } catch (err) {
                console.error('Error deleting owner:', err);
                alert('Gagal menghapus owner.');
            }
        }


        // Initial Load - use user's entity
        selectEntity(currentSelectedEntity, document.querySelector(`.entity-btn[data-entity="${currentSelectedEntity}"]`));

    </script>
</body>

</html>